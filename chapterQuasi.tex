\section{MPC на квази-бесконечном горизонте}

Ограничения нулевой терминальной задачи достаточно строгие, так как точное попадение в конце горизонта в начало координат не всегда выполнимо, поэтому введем новые ослабленные ограничения, которые будут представлять собой терминальное множество и терминальную функцию. Внутри терминального множества введем локальную функцию управления Ляпунова. Теперь в конце горизонта мы не будем требовать попадение в начало координат, а будем требовать попадение в терминальное множество, в котором уже можно за счет локальной функции Ляпунова достичь начала координат.

Задача оптимизации MPC. 

В момент времени $t$, находим значение состояния $x(t)$
\begin{equation*}
\min_{\bar u(\cdot;t)} J(x(t),\bar u(\cdot;t)) = \int_t^{t+T}L(\bar x(\tau;t), \bar u(\tau;t))d\tau + F(\bar x(t+T;t)) 
\end{equation*}

где $F(\bar x(t+T;t))$ - функции стоимости терминального состояния, т.е. терминальная функция. Условия остались прежними, за исключением того, что вместо $\bar x(t+T;t) = 0$ мы теперь требуем $\bar x(t+T;t) \in X^f$. 

\begin{equation*}
\dot{\bar x} = f(\bar x, \bar u), \bar x(t;t) = x(t)
\end{equation*}
\begin{equation*}
\bar x(t;t) \in X, \ \bar u(t;t) \in U, \ \forall \tau \in [t,t+T]
\end{equation*}
\begin{equation*}
\bar x(t+T;t) \in X^f
\end{equation*}

Множество состояний $X^f$ - терминальный регион.

Оптимальное решение $\bar u^*(\cdot, t)$ и оптимальное значение функции с оптимальным управлением $J^*(x(t))$.

Введем предположения относительно терминального региона и терминальной функции:

Пусть существует локальное вспомогательное
управление $u = k^{loc}(x)$, такое что
\begin{enumerate}
\item Множество $X^f$ является инвариантным множеством для динамики системы
 $\dot x = f(x,k^{loc}(x))$
\item Управление $k^{loc}(x) \in U \ \forall x \in X^f$, т.е. локальное управление является допустимым для всех состояний терминального региона
\item $\dot F(x) + L(x, k^{loc}(x)) \leq 0 \ \forall x \in X^f$,
\end{enumerate}

Из этого следует, что $F$ это локальная функция Ляпунова.

\begin{Theorem}

Предположим, что предположения о терминальной функции и регионе выполняются и задача
MPC выполнима в точке $t=0$. Тогда:
\begin{itemize}
\item задача рекурсивна разрешима
\item закрытая система является асимптотически 
устойчивой
\end{itemize}
\end{Theorem}

Как предположения о терминальной функции и регионе могут быть удовлетворены?

Предположим:
\begin{itemize}
\item функция стоимости перехода является 
квадратической $L(x,u) = x^TQx + u^TRu, \ Q,R >0$
\item линеаризация в нуле стабилизируемая, т.е. представима исходная система в виде
$\dot x = Ax+Bu$, где $A = \frac{\partial F}{\partial x}(0,0), \ B = \frac{\partial F}{\partial u}(0,0)$
\end{itemize} 

Тогда будем искать терминальную функцию и регион в следующем виде: 
\begin{itemize}
\item Линейное вспомогательное управление $k^{loc}(x)=Kx$
\item Квадратическая терминальная функция $F(x) = x^TPx$, $P > 0$
\item Терминальный регион $X_{\alpha}^f = \{x \in \mathbb{R}^n | x^TPx \leq \alpha\}$ для некоторой $\alpha > 0$
\end{itemize}

Определим $P,K,\alpha$ так что предположения о терминальной функции и регионе выполняются.

Для предположения $\dot F(x) + L(x, k^{loc}(x)) \leq 0 \ \forall x \in X^f$:
\begin{equation*}
L(x,u) = x^TQx + u^TRu = [u=Kx] = x^T(Q+K^TRK)x = x^TQ^*x
\end{equation*}
Тогда перепишем неравенство из предположения в виде:
\begin{equation*}
\frac{d}{dt}x(t)^TPx(t) \leq - x(t)^t(Q + K^TRK)x(t) = - x(t)^TQ^*x(t)
\end{equation*}
Производная от терминальной функции распишем в таком виде
\begin{equation*}
\frac{d}{dt}x(t)^TPx(t) = f(x,Kx)^TPx + x^TPf(x,Kx)
\end{equation*}

Из линеаризованности системы следует, что $f(x,Kx) = (A+BK)x+\phi(x)$, обозначим $A+BK = A_K$, где $K$ 
выбирается так, что $A+BK$ является гурвицевой.

Теперь производную перепишем в виде:
\begin{equation}\label{diff_term_func}
\frac{d}{dt}x(t)^TPx(t) = x^T(A_KP + PA_K)x + 2x^TP\phi(x)
\end{equation}

Необходимо определить верхнюю границу для $x^TP\phi(x)$:
Введем норму функции нелинейности $\phi(x)$ внутри терминального региона
$L_{\phi} := sup\{ \frac{|\phi(x)|}{|x|}, x \in X_{\alpha}^{f}, x \neq 0\}$ 

Тогда верхняя граница будет иметь такой вид
\begin{equation}\label{nonlinearity_inequality}
x^TP\phi(x) \leq |x^TP| |\phi(x)| \leq \| P\| L_{\phi} |x|^2 \leq \frac{\|P\|L_{\phi}}{\lambda_{min}(P)}x^TPx
\end{equation}

Выберем $\alpha$ достаточно малой для того, чтобы выполнялось следующее неравенство для некоторого $k > 0$:
\begin{equation}\label{alpha_choice}
L_{\phi} \leq \frac{k \lambda_{min}(P)}{\|P\|} 
\end{equation}

Подставим (\ref{alpha_choice}) в (\ref{nonlinearity_inequality}) и получим:  $x^TP\phi(x) \leq kx^TPx$. Подставим полученное неравенство  в (\ref{diff_term_func}) и получим
\begin{equation*}
\frac{d}{dt}x^TPx \leq x^T(A_KP + PA_K)x + 2kx^TPx = x^T((A_K + kI)^TP + P(A_K+kI))x
\end{equation*}
все это нам гарантирует, что $\frac{d}{dt}x^TPx \leq - x^TQ^*x$,

$\Rightarrow$ равенство Ляпунова может быть решено 
тогда и только тогда, когда $A_K + kI$ является
гурвицевой, в свою очередь этого можно добиться тогда и только когда,$k$ выбирается из следующего неравенства 
\begin{equation}\label{k_choice_inequality}
k < - max\ Re \{ \lambda(A_K)\}
\end{equation}
Тогда получим уравнение Ляпунова из которого можно получить матрицу $P$ для терминальной функции:
\begin{equation}\label{lyapunov_equation}
\Rightarrow\ (A_K + kI)^TP + P(A_K + kI) = - Q^*
\end{equation}

Алгоритм нахождения терминальной функции и региона, основанный на всех выше перечисленных предположениях:
\begin{enumerate}
\item Найдем $K$ такое, что $(A+BK)$ гурвицева, тогда локальное управление будет $u = Kx$ 
\item Выберем $k > 0$ такое, что неравенство  (\ref{k_choice_inequality}) верно и решаем уравнение Ляпунова (\ref{lyapunov_equation})
\item Найдем наибольшее $\alpha_1$ такое что $Kx \in U, \ \forall x \in X^f_{\alpha_1}$, т.е. наше локальное управление остается допустимым для всех состояний терминального региона задаваемого как $X_{\alpha_1}^f =\{x \in \mathbb{R}^n | x^TPx \leq \alpha_1\}$
\item Найдем наибольшее $\alpha \in (0,\alpha_1]$ такое
что (\ref{alpha_choice}) выполняется.
\end{enumerate}

Шаг (4) мы можем заменить на альтернативный и решать ззадачу оптимизации 
\begin{equation}
\max_{x} x^TP\phi(x) - kx^TPx \ \ \ s.t. \ x^TPx \leq \alpha
\end{equation}

Постепенно будем уменьшать $\alpha$ относительно 
$\alpha_1$ до тех пор, пока оптимальное значение
$\max_{x} x^TP\phi(x) - kx^TPx$ является отрицательным.

В итоге мы имеем следующие степени свободы:
\begin{itemize}
\item нахождение $K$ для локального управления Ляпунова
\item выбор $k$ определяет компромисс между "большим"
 терминальным регионом и большой матрицей $P$ для терминальной функции
\end{itemize}
