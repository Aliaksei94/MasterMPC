\chapter{Динамическая модель портфельной оптимизации}

\section{Базовые определения модели}

В данной главе введем основные понятия и обозначения,
которые будем использовать в дальнейшем для 
решения задачи оптимизации портфеля.


Портфель -- совокупность инвестиционных вложений, состоящих из ценных бумаг и 
свободных финансов.

Портфель состоит из $N$ типов бумаг. Количество бумаг $i$-го типа в момент времени
$t\ge 0$ равняется $x_i(t)$, где $x_i(t)\in \mathbb{R}_{\ge 0}$. 
Обозначим $x_0(t)$ как
количество свободных финансов в момент времени $t$.

Под $u^+_i(t)$ будем понимать сколько инвестор купил
ценных бумаг типа $i$ в момент времени
$t$. Под $u^-_i(t)$ будем понимать сколько инвестор продал
ценных бумаг типа $i$ в момент времени
$t$. При этом стоимость
покупки этой бумаги равна $b_i(t)$ (buy), а продажа $s_i(t)$ (sell).

Таким образом, на каждом шаге покупаем ценнных
бумаг типа $i$ на сумму 
$b_i(t)u^+_i(t)$ и продаем на сумму $s_i(t)u^-_i(t)$.

Таким образом, количество свободных средств в следующий момент времени будет
равно 

\begin{equation}\label{eq:x0}
x_0(t+1) = x_0(t) + \sum_{i=1}^N 
\left( -u^+_i(t)b_i(t) + u^-_i(t)s_i(t)\right).
\end{equation}


Количество ценных бумаг типа $i$ в момент времени $t+1$
будет равно

\begin{equation}\label{eq:xi}
x_i(t+1) = x_i(t) + u^+(i) - u^-(i).
\end{equation}

Представим все это в векторной форме. Введем следующие определения:

\begin{equation}\label{eq:vec}
\begin{split}
&X(t) = [x_1(t),x_2(t),\dots,x_N(t)]^T; \\
&U^+(t)=[u^+_1(t),\dots,u^+_N(t)]^T; \\
&U^-(t)=[u^-_1(t),\dots,u^-_1(t)]^T; \\
&B(t)=[b_1(t),\dots,b_N(t)]^T; \\
&S(t)=[s_1(t),\dots,s_N(t)]^T.
\end{split}
\end{equation}

Сейчас используя (\ref{eq:vec}) перепишем (\ref{eq:xi})
для $X(t)$:

\begin{equation}
X(t+1) = X(t) + U^+(t) - U^-(t).
\end{equation}


Представим (\ref{eq:x0}) в векторной форме:

\begin{equation}\label{def:xt}
x_0(t+1) = x_0(t) + U^+(t)^t B(t) - U^-(t)^t S(t).
\end{equation}


На значения $X$, $x_0$, $U^+$, $U^-$ накладываются следующие 
естественные ограничения:

\begin{equation}
 \begin{split}
    &X(t)\ge 0, \ \ \forall t\ge 0;\\
    &x_0(t)\ge 0; \\
    &U^+(t)\ge 0, \ \ \forall t\ge 0; \\
    &U^-(t)\ge 0. \\    
 \end{split}
\end{equation}

Введем понятие общей стоимости портфеля.

Пусть $w_i(t)$ общая стоимость бумаг типа $i$, и она равна сумме, которую 
сейчас можем выручить из ее продажи, т.е. $w_i(t) = s_i(t) x_i(t)$. Значение $w_0(t)$
будем считать равным $x_0(t)$. Тогда общая стоимость портфеля равна
$$w(t) = \sum_{i=0}^N w_i(t).$$

Или в векторном виде, используя (\ref{eq:vec}):
$$w(t) = x_0(t) + X(t)^T S(t).$$

\subsection{Данные для численных экспериментов}

В данной главе описаны данные, которые используются для проведения численных экспериментов. Тут же дано описание того,
как строятся прогнозы для значений функций $s_i(t)$ и
$b_i(t)$ в случае, когда работаем с недетерминированной моделью, то есть заранее их точные значения не известны.

Будем работать с двумя типами данных, сгенерированных искусственно и реальными 
котировками на рынке криптовалют.

Сгенерированные данные представляют собой сумму линейной и синусоидальной функции

\begin{equation}\label{eq:sin_gen}
\begin{split}
&B_i(t) = k_{i0} + k_i t + \alpha_i \sin(r_i + g_i t); \\
&S_i(t) = 0.99 B_i(t).
\end{split}
\end{equation}


Для (\ref{eq:sin_gen}) значения $k_{i0}$, $k_i$, $\alpha_i$, $r_i$, $g_i$ подбираются таким образом, чтоб ни для
каких $i \neq j$ не совпадали периоды. $S_i(t)$ выбрана в таком виде, так как
это является неплохим приближением реально существующий картины, когда
разница между покупкой и продажей приблизительно равна фиксированному проценту.

Реальные же данные взяты из исторических курсов на 
сайте {\it coinmarketcap.com} за период ... 

Тут вставить графики функций

\subsubsection{Предсказание значений}

В общем случае, значения $S_i(t)$ и $B_i(t)$ в будущие
моменты времени не известны. В этой работе будем прогнозировать будущие значения на основе предыдущих
наблюдений. 

В работе используется линейная регрессионная модель [1], зависимости стоимости от
времени, в этом разделе будет дано краткое теоретическое ее описание и пример
использования для приближенного нахождения будущих значений.

Линейная регрессия — метод восстановления зависимости между двумя переменными.

Для заданного множества из m пар $(x_i, y_i)$, $i=1,\ldots, m$, значений свободной и зависимой переменной требуется построить зависимость. Назначена линейная модель

$$y_i= f(\mathbf{w},x_i) + \varepsilon_i$$

c аддитивной случайной величиной $\varepsilon$. Переменные $x$, $y$ принимают значения на числовой прямой $\mathbb{R}$.

Определим модель зависимости как

$$y_i= w_1 + w_2x_i + \varepsilon_i.$$

Согласно методу наименьших квадратов, искомый вектор параметров $\mathbf{w}=(w_1,w_2)^T$ есть решение нормального уравнения

$$\mathbf{w} = (A^TA)^{-1}A^T\mathbf{y},$$

где $\mathbf{y}$ — вектор, состоящий из значений зависимой переменной, $\mathbf{y}=(y_1,\ldots, y_m)$. Столбцы матрицы $A$ есть подстановки значений свободной переменной $x_i^0\mapsto a_{i1}$ и $x_i^1\mapsto a_{i2}$,
 $i=1,\ldots, m$. Матрица имеет вид

$$A =\left(\begin{array}{cc} 1 & x_1\\ 1 & x_2\\ \ldots & \ldots \\ 1 & x_m\\ \end{array} \right).$$
Зависимая переменная восстанавливается по полученным весам и заданным значениям свободной переменной

$$y^*_i = w_1+w_2x_i,$$
иначе

$$\mathbf{y}^* = A\mathbf{w}.$$

Для оценки качества модели используется критерий суммы квадратов регрессионных остатков, SSE — Sum of Squared Errors.

$$SSE = \sum_{i=1}^m(y_i-y_i^*)^2 = (\mathbf{y}-\mathbf{y}^*)^T(\mathbf{y}-\mathbf{y}^*).$$

[1]Стрижов В. В. Методы индуктивного порождения регрессионных моделей. – Вычислительный центр им. АА Дородницына РАН, 2008.

\subsubsection{Оценка прогнозирования} 

В данной секции рассказывается о качестве найденных оценок[2]. Находится их смещение, вычисляется распределение и дисперсия ошибки.

[2]Боровков А. А. Глава 4. Числовые характеристики случайных величин;—5-е изд //М.: Либроком. – 2009.

Для нахождения математического ожидания и вариации ошибки будем использовать
встроенные $Matlab$ функции $var$, $mean$.
Данные функции вычисляют следующие значения:

$$\mu = \frac{1}{N}\sum_{i=1}^N A_i$$

$$V = \frac{1}{N-1} \sum_{i=1}^{N} |A_i - \mu|^2$$

В процессе прогнозирования, вычисляется ошибка следующим образом

$$e(t) = \frac{x_{predicted}(t)-x_{real}(t)}{x_{real}(t)}$$

Данная ошибка была подсчитана для прогнозирования от одного до шести шагов вперед.
На рисунке (\ref{fig:pred}) изображены распределения ошибок прогнозирование будущих стоимостей продаж ценных
бумаг.

\begin{figure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred1}
  \caption{На 1 шаг}
  \label{fig:sfig1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred2}
  \caption{На 2 шага}
  \label{fig:sfig2}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred3}
  \caption{На 3 шага}
  \label{fig:sfig1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred4}
  \caption{На 4 шага}
  \label{fig:sfig2}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred5}
  \caption{На 5 шагов}
  \label{fig:sfig1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred6}
  \caption{На 6 шагов}
  \label{fig:sfig2}
\end{subfigure}
\caption{Распределение ошибок предсказания}
\label{fig:pred}
\end{figure}

В таблице (\ref{t:err}) приведены численные значения 
математического ожидания и вариации для предсказаний


\begin{table}
\begin{center}
\begin{tabular}{|l|l|l|}
\hline 
t & mean & var \\ \hline
1 & 0.0007 & 0.0036 \\ \hline
2 & 0.0007 & 0.0083  \\ \hline
3 & 0.0012 & 0.0162 \\ \hline
4 & 0.0032 & 0.0265 \\ \hline
5 & 0.0043 & 0.0389 \\ \hline
6 & 0.0064 & 0.0545 \\ \hline
\end{tabular}
\label{t:err}
\caption{Ошибки прогнозирования}
\end{center}
\end{table}


Дисперсия будет в дальнейшем использоваться для функции стоимости перехода в виде

$$L_t(U^+(t),U^-(t)) = \alpha * D[e(t)] \left(\bar B(t)^T U^+(t) + \bar S(t)^T U^-(t)\right)^2$$

Где $W(t)$ это собственно и сама ошибка прогнозирования.

Так как значения математического ожидания, представленные
в таблице \ref{t:err}, близки к нулю, то будем считать,
что полученные оценки являются несмещенными.

\subsection{Детерменированная модель}

В данной главе рассмотрим детерминированную модель,
а именно, когда нам точно известны наперед все значения $s_i(t)$
и $b_i(t)$.

Иными словами $\bar S(t) = S(t)$ и $\bar B(t) = B(t)$

В таком случае, можем рассмотреть следующие модели:

\begin{itemize}
\item максимизация стоимости портфеля без терминального множества
\item максимизация стоимости портфеля с терминальным множеством
\end{itemize}

{\bf Максимизация стоимости портфеля без терминального множества}

Рассмотрим следующую задачу MPC на горизонте планирования $T$

\begin{equation}
\begin{split}
&\max_{U^+, U^-} J(X_0, x_0,U^+, U^-) = w(t_0+T) = x_0(t_0+T)+S(t_0+T)^T X(t_0 + T); \\
&X(t+1) = X(t) + U^+(t) - U^-(t); \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t)  \\
&X(t_0) = X_0; \\
&x_(t_0) = x_0; \\
&X(t)\ge 0, \ \  t= \overline{t_0,t_0+T}; \\
&x_0(t)\ge 0; \\
&U^+(t)\ge 0, \ \  t= \overline{t_0,t_0+T-1}; \\
&U^-(t)\ge 0.
\end{split}
\end{equation}

Отметим, что в данной задаче функция стоимости не ограничена,
кроме того, тут отсутствует функция стоимости этапа а есть только
терминальная стоимость.

Так как предположение $J^{*}_{\infty}(x_0) < \infty$ из главы (\ref{chap3}) не выполняется, то не можем гарантировать 
устойчивость и исследовать на субоптимальность.

Проведем численные эксперименты для $T=6$ и $N=2$ для
синтетических и настоящих данных.

На рисунке (\ref{fig:det_no_reg}) представлены данные численного 
эксперимента. Верхний график показывает количество 
ценных бумаг первого и второго типа в каждый
момент времени. Нижний график представляет 
собой общую стоимость базового портфеля (с тревиальным
управление) и стоимость портфеля под управлением MPC.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/det_no_regul}
  \caption{Детерменированная модель без регуляризации}
  \label{fig:det_no_reg}
\end{figure}

Как видим, у нас происходят частые операции вида: продать
все бумаги типа $i$ и на освободившиеся деньги купить
бумаги типа $j$. Это может представлять собой проблему,
так как инвестору приходится постоянно перестраивать
портфель, что может
привносить с собой большие риски (подробнее об этом будет
рассказано в главе с недетерменированной моделью).

Изменим функцию стоимости таким образом, чтоб добавить в нее
стоимость этапа.

$\min_{U^+, U^-} J(x,u) = \sum_{i=0}^T L(U^+(i), U^-(i)) - w(T).$

Если в качестве функции стоимости взять, скажем

$$L(U^+(t), U^-(t)) = \alpha( B(t)^T U^+(t) + S(t)^T U^-(t))^2,$$

то есть весь оборот денег, который был в момент $t$, то наши
графики изменятся уже следующим образом (для $\alpha=0.01$) рисунок \ref{fig:det_reg}.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/det_regul}
  \caption{Детерменированная модель с регуляризацией}
  \label{fig:det_reg}
\end{figure}

Представим результаты аналогичных экспериментов, но 
уже с генерированными тестовыми данными. Без
стоимости этапа рисунок \ref{fig:det_no_reg_sin}, со
стоимостью этапа \ref{fig:det_regul_sin}.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/det_no_regul_sin}
  \caption{Детерменированная модель без регуляризацией}
  \label{fig:det_no_reg_sin}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/det_regul_sin}
  \caption{Детерменированная модель с регуляризацией}
  \label{fig:det_regul_sin}
\end{figure}

{\bf Максимизация стоимости портфеля с терминальным множеством}

Рассмотрим следующую задачу MPC на горизонте планирования $T$

\begin{equation}\label{term_reg}
\begin{split}
&\max_{U^+, U^-} J(x_0, X_0,U^+,U^-) = x_0(t_0+T) + X(t_0+T)^T S(t_0+T); \\
&X(t+1) = X(t) + U^+(t) - U^-(t); \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t);  \\
&X(t_0) = X_0; \\
&x_(t_0) = x_0; \\
&X(t)\ge 0, \ \ t= \overline{t_0,t_0+T}; \\
&x_0(t)\ge 0; \\
&U^+(t)\ge 0, \ \ t= overline{t_0,t_0+T-1}; \\
&U^-(t)\ge 0;\\
&\frac{x_k(t_0+T)}{\sum_{i=0}^N x_i(t_0+T)} = \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \ \forall k\in \overline{0,N}.
\end{split}
\end{equation}

Иначе говоря, требуется, чтоб в момент времени $t_0+T$ пропорции
в портфеле вернулись к тем, что были в нулевой момент времени.
Идея данного подхода совпадает с той, что используется в
экономическом MPC (только там в качестве устойчивого состояния
используется точка $x_s$, а в данном случае это целый луч, содержащий значения с одинаковыми пропорциями).
Кроме того, этот подход дает возможность
сравнивать эффективность управления MPC без учета
колебания курсов. Так как отношения стоимостей 
портфелей с тривиальным
управление, и с управлением MPC, если они содержат 
одинаковые пропорции, не зависит от текущих курсов. 

\begin{theorem}
Задача (\ref{term_reg}) разрешима
\begin{proof}
Заметим, что управление 

$$U^+(t_0+t)=U^-(t_0+t)\equiv 0,\ \ \forall t= \overline{0,T-1}$$

является допустимым, кроме того, при этом управлении значение функции $\max_{U^+, U^-} J(x_0, X_0,U^+,U^-)$ из (\ref{term_reg}) следовательно наша задача разрешима.
\end{proof}
\end{theorem} 


\begin{theorem}
Пусть для $x_0(0),X(0)$ из задачи (\ref{term_req})
получено управление MPC 
$$\{(U^+(0), U^-(0)), (U^+(1), U^-(1)), \dots\},$$ 
и соответствующая ей траектория
$$\{(\hat X(0), \hat x_0(0)), (\hat X(1), \hat x_0(1)), \dots \}$$
тогда любого $m \in \mathbb{Z}_+$ верно:
$$\max_{U^+, U^-} J(\hat X(m), \hat x_0(m),U^+, U^-) \ge x_0(0) + X(0)^T S(m+T).$$
\begin{proof}
Будет добавлено позже
\end{proof}
\end{theorem} 

Иными словами, это означает, что в любой момент времени, 
портфель, управляемый MPC за $T$ шагов может быть приведен
в терминальное множество и при этом стоимость портфеля будет
не меньше, нежели бы постоянно использовалось тривиальное управление.

Приведем пример, как будет вести себя наша система
с терминальным множеством. На рисунке \ref{fig:det_regul_term_sin} представлен результат
численного эксперимента для сгенерированных данных.
Как видно, результативная стоимость получается меньше,
нежели в случае без терминального множества (рисунок 
\ref{fig:det_regul_sin}). Но при этом уже диапазон, в 
котором изменяется количество ценных бумаг каждого 
типа.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/det_regul_term_sin}
  \caption{Детерменированная модель с регуляризацией}
  \label{fig:det_regul_term_sin}
\end{figure}

\subsection{Недетерминированная модель}

В данной главе рассмотрен случай, когда точно не известны будущие стоимости 
активов и модель должна оперировать прогнозируемыми
значениями на горизонте планирования.

Покажем, что для недетерминированного случая
нельзя просто использовать предсказания и работать
как в детерминированном случае без регуляризации.

На рисунке \ref{fig:nodet_no_reg_no_term} представлен
такой случай, при этом на нижнем графике видно, что
стоимость портфеля при тривиальном управлении будет 
выше, нежели при управлении MPC.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/no_det_no_term_not_regul}
  \caption{Недетерменированная модель без регуляризацией}
  \label{fig:nodet_no_reg_no_term}
\end{figure}

Это связано с тем, что управление строится на основе
прогнозируемых данных, и при этом одинаково учитывается
весь горизонт планирования. А хотелось бы сделать
так, чтоб более дальним прогнозам уделялось
меньше внимания.

Из это делаем вывод, что необходимо вводить функцию
стоимости этапа, которая будет учитывать ошибки
прогнозирования.

В случае, когда точно не известны значения $s_i(t)$ и $b_i(t)$, 
наша функция перехода для $x_0(t)$, в соответствии
с (\ref{def:xt}) имеет следующий вид:

\begin{equation}
x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t).
\end{equation}

Где $B(t)$ и $S(t)$ описаны в (\ref{eq:vec}).

И при этом $B(t) = (I + E_1(t))\bar B(t)$, где $\bar B(t)$ это прогнозируемое значение, $I$ -- единичная
матрица, $E_1(t)$ -- случайная диагональная матрица ошибок, при этом $M[E_1(t)] = 0$ (ссылка на часть
с оценкой ошибок прогнозирования). Аналогично для $S(t) = \bar S(t)(1 + E_2(t))$.

Так как изменение цены покупки и продажи происходит одинаково, то будем считать, 
что $E_1(t)\equiv E_2(t) = E(t)$

Сейчас перепишем (\ref{def:xt}):

\begin{equation}
\begin{split}
x_0(t+1) &= x_0(t) - \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t) - \\
&- \left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t).
\end{split}
\end{equation}

Оценим для величины $x_0(t+1)$ математическое ожидание и дисперсию:

\begin{equation}\label{ned_exp}
M[x_0(t+1)] = M[x_0(t)] + \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t) 
\end{equation}

Будем считать, что величины $x_0(t)$ и $W(t)$ независимы, кроме того, стоимости активов не коррелируют
\begin{equation}
\begin{split}
D[x_0(t+1)] &= D[x_0(t) - \left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t)]= \\
 &=D[x_0(t)] + D[\left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t)]\le \\
 &=D[x_0(t)] + \langle\bar B(t)^T D[E(t)], U^+(t)\rangle^2 + \langle\bar S(t)^T D[E(t)], U^-(t)\rangle^2.
\end{split}
\end{equation}

Сейчас можем добавить учет дисперсии в функцию перехода, эта добавка будит служить
своего рода ограничением дисперсии при максимизации математического ожидания. Введем функцию стоимости
этапа следующим образом:

\begin{equation}
L(U^+(t),U^-(t)) = \alpha  \langle\bar B(t)^T D[E(t)], U^+(t)\rangle^2 + \langle\bar S(t)^T D[E(t)], U^-(t)\rangle^2.
\end{equation}


Оценки на значения $D[E(t)]$ зависят от способа предсказания векторов $S(t)$ и $B(t)$.

\begin{equation}\label{term_reg}
\begin{split}
&\max_{U^+, U^-} -\sum_{t=0}^{T-1} L_t(U^+(t_0+t),U^-(t_0+t)) + \\ 
&\ \ \ \ \ \ \ \ \ \ + x_0(t_0+T) + S(t_0+T)^T X(t_0+T);  \\
&X(t+1) = X(t) + U^+(t) - U^-(t) \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t)  \\
&X(t_0) = X_0; \\
&x_(t_0) = x_0; \\
&X(t)\ge 0, \ \ t= \overline{t_0,t_0+T}; \\
&x_0(t)\ge 0; \\
&U^+(t)\ge 0, \ \ t= overline{t_0,t_0+T-1}; \\
&U^-(t)\ge 0;\\
&\frac{x_k(t_0+T)}{\sum_{i=0}^N x_i(t_0+T)} = \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \ \forall k\in \overline{0,N}.
\end{split}
\end{equation}

Результат применения данного управления представлен 
на рисунке \ref{fig:nodet_reg_term}. Тут видим, что 
применение управления MPC уже лучше, нежели 
тривиальное управление.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/nodet_term_reg}
  \caption{Недетерменированная модель с регуляризацией}
  \label{fig:nodet_reg_term}
\end{figure}

