\chapter{ДИНАМИЧЕСКИЕ МОДЕЛИ ПОРТФЕЛЬНОЙ ОПТИМИЗАЦИИ. ДЕТЕРМИНИРОВАННЫЙ СЛУЧАЙ}

В настоящей главе вводятся основные понятия и определения, строятся математические модели, описывающие динамику инвестиционного портфеля, и формулируются задачи его оптимизации. Рассматриваемые модели можно разбить на два класса: в которых заданы функции цены покупки и продажи ценных бумаг, и в которых указанные функции прогнозируются на заданном горизонте планирования. Описываются данные, которые будут использоваться для проведения численных экспериментов. Обсуждаются достоинства и недостатки различных подходов при оптимизации портфелей.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Основные положения модели}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


Портфель --- совокупность инвестиционных вложений, состоящих из ценных бумаг и
свободных финансов.

Портфель состоит из $N$ типов бумаг. Количество бумаг $i$-го типа ($i = \overline{1,N}$) в момент времени $t\ge 0$ равняется $x_i(t)$, где $x_i(t)\ge 0$.
Обозначим через $x_0(t)$ --- количество свободных финансов в момент времени $t\ge 0$.

Через $u^+_i(t)$ будем обозначать количество  ценных бумаг типа $i$, которые инвестор купил в момент времени
$t$. Соответственно, через $u^-_i(t)$ обозначим, сколько инвестор продал
ценных бумаг типа $i$ в момент времени $t$. Пусть стоимость
покупки $i$-ой бумаги равна $b_i(t)\ge 0$ (buy), а продажа $s_i(t)\ge 0$ (sell). Конкретный вид функций $s_i(t)$, $b_i(t)$, $t\ge 0$ будет обсуждаться ниже, в разделе~\ref{sec:exp_data}.

Таким образом, в момент времени $t$ инвестор покупает ценных бумаг типа $i$ на сумму $b_i(t)u^+_i(t)$ и продает на сумму $s_i(t)u^-_i(t)$.

Тогда количество свободных средств в следующий момент времени $t+1$ будет
равно
\begin{equation}\label{eq:x0}
    x_0(t+1) = x_0(t) + \sum_{i=1}^N
        \left( -u^+_i(t)b_i(t) + u^-_i(t)s_i(t)\right).
\end{equation}


Количество ценных бумаг типа $i$ в момент времени $t+1$
будет равно
\begin{equation}\label{eq:xi}
    x_i(t+1) = x_i(t) + u^+(i) - u^-(i).
\end{equation}

Считаем, что в начальный момент времени  заданы начальные условия --- количество бумаг каждого типа и объем свободных средств, которыми располагает инвестор:
$$
    x_i(0) = x_{i0}, \ i=\overline{1,N}; \ \ x_0(0) = x_{00}.
    $$

Введенные переменные и уравнения (\ref{eq:x0}), (\ref{eq:xi}) представим в векторной форме. Введем следующие векторы:
\begin{equation}\label{eq:vec}
\begin{split}
& X(t) = [x_1(t),x_2(t),\dots,x_N(t)]^T; \\
& U^+(t)=[u^+_1(t),\dots,u^+_N(t)]^T; \\
& U^-(t)=[u^-_1(t),\dots,u^-_N(t)]^T; \\
& B(t)=[b_1(t),\dots,b_N(t)]^T; \\
& S(t)=[s_1(t),\dots,s_N(t)]^T; \\
& X_0=[x_{10},\dots,x_{N0}]^T.
\end{split}
\end{equation}

Используя (\ref{eq:vec}), перепишем (\ref{eq:xi}) для $X(t)$:
\begin{equation}\label{eq:Xvec}
    X(t+1) = X(t) + U^+(t) - U^-(t),  \ \ X(0) = X_0,  \ \ t\ge 0.
\end{equation}


Представим (\ref{eq:x0}) в векторной форме:
\begin{equation}\label{eq:x0vec}
    x_0(t+1) = x_0(t) -  B(t)^T U^+(t)+ S(t)^T U^-(t), \ \ x_0(0) = x_{00}, \ \ t\ge 0.
\end{equation}



На значения $X(t)$, $x_0(t)$, $U^+(t)$, $U^-(t)$  в каждый момент времени $t$ накладываются следующие естественные ограничения:
\begin{equation}\label{eq:constr}
 \begin{split}
    & X(t)\ge 0,\\
    & x_0(t)\ge 0, \\
    & U^+(t)\ge 0,\\
    & U^-(t)\ge 0, \\
    & t\ge 0.\\
 \end{split}
\end{equation}

С точки зрения теории управления, в динамической модели (\ref{eq:Xvec}) --  (\ref{eq:constr}): переменные $X(t)\in \mathbb{R}^N$, $x_0(t)\in \mathbb{R}$ --- фазовые переменные (зависимые), переменные $U^+(t)\in \mathbb{R}^N$, $U^-(t)\in \mathbb{R}^N$ --- управляющие переменные (управления, независимые), динамическая модель нестационарная в силу зависимости от времени функций цены покупки $B(t)$, $t\ge 0$, и цены продажи $S(t)$, $t\ge 0$. Ограничения (\ref{eq:constr}), накладываются как на управляющие, так и на фазовые переменные.



\bigskip

Введем понятие общей стоимости портфеля.

Пусть $w_i(t)$ --- общая стоимость бумаг типа $i$, и она равна сумме, которую
инвестор  может выручить из ее продажи в момент времени $t$: 
$$
    w_i(t) = s_i(t) x_i(t).
    $$
Значение $w_0(t)$ будем считать равным $x_0(t)$. Тогда общая стоимость портфеля равна 
$$
    w(t) = \sum_{i=0}^N w_i(t).
    $$

В векторном виде, используя (\ref{eq:vec}), получим следующую формулу для общей стоимости портфеля:
$$
    w(t) = x_0(t) +  S(t)^T X(t).
    $$
    
Задачи оптимизации портфеля, динамика которого описывается согласно (\ref{eq:Xvec}), (\ref{eq:x0vec}) и подчиняется ограничениям (\ref{eq:constr}) будет связана с максимизацией введенной стоимости портфеля при различных дополнительных требованиях. 

Для оптимизации поведения инвестора будем применять методы МРС, описанные в главе 1. Таким образом, в каждый момент времени, начиная с $t=0$ будет решаться прогнозирующая задача оптимального управления. Первое значение ее оптимального управления будет использовано для принятия решения об изменении содержания портфеля в текущий момент времени. Новое полученное состояние портфеля затем используется в качестве начального в задаче оптимального управления в следующий момент времени.Как будет показано ниже, качество полученного замкнутого процесса управления зависит от формулировки прогнозирующей задачи. 


\section{Данные для численных экспериментов}\label{sec:exp_data}

В данном разделе описаны данные, которые используются для проведения численных экспериментов.

Будем работать с двумя типами данных:
\begin{enumerate} 
\item сгенерированных искусственно; 
\item реальными котировками на рынке криптовалют.
\end{enumerate}

Сгенерированные данные представляют собой сумму линейной и синусоидальной функции
\begin{equation}\label{eq:sin_gen}
\begin{split}
&b_i(t) = k_{i0} + k_i t + \alpha_i \sin(r_i + g_i t); \\
&s_i(t) = 0.95 b_i(t).
\end{split}
\end{equation}


Для (\ref{eq:sin_gen}) значения $k_{i0}$, $k_i$, $\alpha_i$, $r_i$, $g_i$ подбираются таким образом, чтобы ни для
каких $i \neq j$ не совпадали периоды. Выбор функции $s_i(t)$ в представленном виде обусловлен тем наблюдением реально существующий картины, что разница между покупкой и продажей приблизительно равна фиксированному проценту, и таким образом, она будет хорошим приближением для используемых данных.

Графики сгенерированных значений представлены на
рисунке \ref{fig:plot_sin}.

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/plot_sin}
  \caption{График сгенерированных значений}
  \label{fig:plot_sin}
\end{figure}

Реальные данные взяты из исторических курсов на
сайте {\it coinmarketcap.com} за период с 10.02.2018
по 27.06.2018.

Графики реальных курсов представлены на рисунке 
\ref{fig:plot_crypto}.

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/plot_crypto}
  \caption{График реальных курсов}
  \label{fig:plot_crypto}
\end{figure}



\section{Модель без терминального множества}

Настоящий и следующий разделы посвящены исследованию детерминированной модели оптимизации портфеля, т.е. случаю, когда в начальный момент времени точно известны все значения цены продажи и покупки $s_i(t)$ 
и $b_i(t)$, $t\ge 0$, $i = \overline{1,N}$.

Будем применять методы МРС, описанные в главе 1 для задачи оптимизации портфеля. При этом рассматривается прогнозирующая задача МРС с конечным горизонтом прогнозирования $T$ максимизации стоимости портфеля без условий в терминальный момент времени $t+T$ (без терминального множества).

\begin{itemize}
\item задача ;
\item задача максимизации стоимости портфеля с условиями в терминальный момент времени $t+T$ (с терминальным множеством).
\end{itemize}


Рассмотрим следующую задачу MPC c горизонтом планирования $T$
\begin{equation}\label{eq:det1}
\begin{split}
\max_{\bar U^+, \bar U^-} J(X(t), x_0(t),\bar U^+, \bar U^-) & = w(t+T) = \\ 
        & =  \bar x_0(t+T)+S(t+T)^T \bar X(t + T),
\end{split}
\end{equation}
при условиях
\begin{equation}\label{eq:det2}
\begin{split}
&\bar X(\tau + 1) = \bar X(\tau) + \bar U^+(\tau) - \bar U^-(\tau), \\
&\bar x_0(\tau+1) = \bar x_0(\tau) - B(\tau)^T \bar U^+(\tau) + S(\tau)^T \bar U^-(\tau),  \\
&\bar X(t) = X(t), \\
&\bar x_0(t) = x_{0}(t), \\
&\bar X(\tau)\ge 0, \ \   \\
&\bar x_0(\tau)\ge 0, \ \ \tau= \overline{t,t+T}, \\
&\bar U^+(\tau)\ge 0, \ \   \\
&\bar U^-(\tau)\ge 0, \ \ \tau= \overline{t,t+T-1}.
\end{split}
\end{equation}

Оптимальное решение данной задачи будем обозначать используя
символ $*$:

\begin{equation}
\begin{split}
&\bar U^*_- = \{\bar U^*_-(\tau|t)\}, \\ 
&\bar U^*_+ = \{\bar U^*_-(\tau|t)\},\ \ \  \tau= \overline{t,t+T-1},
\end{split}
\end{equation}

Данному управлению соответствует траектория

$$
	\{(X^*(\tau|t), x^*_0(\tau|t))\},\ \ \ \tau= \overline{t,t+T}.
$$

При этом первое управлением MPC будем называть первое
значение оптимального управления

$$
	(U^{MPC}_+(t), U^{MPC}_+(t)) = (U^*_-(t|t), U^*_+(t|t)).
$$


Отметим, что в  задаче оптимального управления (\ref{eq:det1}) -- (\ref{eq:det2}) функция стоимости 
зависит от функции $S(\tau)$,
кроме того, отсутствует функция стоимости этапа $L_t(\cdot)$, а максимизируется только терминальная стоимость портфеля.

Так как предположение $J^{*}_{\infty}(X(t), x_0(t)) < \infty$ из главы~\ref{chap3} не выполняется, то невозможно  гарантировать устойчивость процесса, замкнутого обратной связью, построенной в результате применения MPC-алгоритма из главы~\ref{chap3} с прогнозирующей задачей оптимального управления  (\ref{eq:det1}) -- (\ref{eq:det2}). Также невозможно исследовать полученное решение на субоптимальность.

\bigskip

Приведем типичную картину поведения инвестора, использующего для управления портфелем задачу (\ref{eq:det1}) -- (\ref{eq:det2}). Для этого приведем результаты численных экспериментов для двух ценных бумаг ($N=2$) при горизонте прогнозирования $T=6$ и используя синтетические и реальные данные.

На рисунке \ref{fig:det_no_reg} представлены данные проведенного численного
эксперимента. Верхний график показывает количество
ценных бумаг первого и второго типа в каждый
момент времени. Нижний график представляет
собой общую стоимость базового портфеля (с тривиальным
управлением --- пунктирная линия) и стоимость портфеля под управлением MPC (сплошная линия).

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/det_no_regul}
  \caption{Детерминированная модель без регуляризации}
  \label{fig:det_no_reg}
\end{figure}

\begin{figure}[h!]
  \includegraphics[width=\linewidth]{figs/det_regul}
  \caption{Детерминированная модель с регуляризацией}
  \label{fig:det_reg}
\end{figure}

Как видно из рисунка \ref{fig:det_no_reg}, при  использовании задачи  (\ref{eq:det1}) -- (\ref{eq:det2}) происходят частые операции вида: продать
все бумаги типа $i$ и на освободившиеся деньги купить
бумаги типа $j$, $i,j = 1,2$. Для инвестора такое поведение может приводить к проблемам, поскольку ему приходится постоянно перестраивать
портфель, что привносит в его поведение большие риски. Подробнее об этом будет
рассказано в главе с недетерминированной моделью.

\bigskip

Изменим критерий качества (\ref{eq:det1}), добавив  в него с целью регуляризации стоимость этапа $L_t(U^+(t), U^-(t))$. 

Получим следующую задачу
\begin{equation}\label{eq:quad_prog}
    \min_{\bar U^+, \bar U^-} J(X(t), x_0(t),\bar U^+, \bar U^-) = \sum_{t=0}^T L_t(U^+(t), U^-(t)) - w(T),
\end{equation}
при условиях (\ref{eq:det2}). Заметим, что здесь критерий качества минимизируется, стоимость портфеля взята за знаком $-$.


Если в качестве функции этапа взять, например, функцию вида
$$
    L_t(U^+(t), U^-(t)) = \alpha( B(t)^T U^+(t) + S(t)^T U^-(t))^2,
    $$
которая характеризует весь оборот денег, произошедший  в момент времени $t$, то графики изменятся (для $\alpha=0.001$) как представлено на рисунке \ref{fig:det_reg}.

При этом отметим, что задача (\ref{eq:quad_prog}) --- задача квадратичного программирования. Для таких задач разработаны эффективные, быстрые  методы решения, в частности, методы внутренней точки \cite{Boyd,NocedalWright}, что чрезвычайно важно при реализации алгоритмов МРС и быстрого принятия решений в каждый момент времени.


\begin{figure}[!h]
\begin{subfigure}{0.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figs/det_no_regul_sin}
  \caption{Без регуляризации}
  \label{fig:det_no_reg_sin}
\end{subfigure}
\begin{subfigure}{0.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figs/det_regul_sin}
  \caption{С регуляризацией}
  \label{fig:det_regul_sin}
\end{subfigure}
\caption{Детерминированная модель на сгенерированных данных}
\end{figure}

Аналогичная рисунку \ref{fig:det_reg} картина получается в численных экспериментах со сгенерированными тестовыми данными. Без функции стоимости этапа результаты представлены на рисунке \ref{fig:det_no_reg_sin}, со
стоимостью этапа --- на рисунке \ref{fig:det_regul_sin}.


\section{Модель с терминальным множеством}

Рассмотрим теперь в качестве прогнозирующей задачи MPC  --- задачу оптимального управления с горизонтом планирования $T$ и ограничениями, накладываемыми на состав портфеля в терминальный момент времени $t_0+T$ (с терминальным множеством):
\begin{equation}\label{term_reg1}
\max_{\bar U^+, \bar U^-} J(X(t), x_0(t),\bar U^+, \bar U^-) = x_0(t+T) +  S(t+T)^T X(t+T); \\
\end{equation}
при условиях
\begin{equation}\label{my_term_reg2}
\begin{split}
&\bar X(\tau + 1) = \bar X(\tau) + \bar U^+(\tau) - \bar U^-(\tau), \\
&\bar x_0(\tau+1) = \bar x_0(\tau) - B(\tau)^T \bar U^+(\tau) + S(\tau)^T \bar U^-(\tau),  \\
&\bar X(t) = X(t), \\
&\bar x_0(t) = x_{0}(t), \\
&\bar X(\tau)\ge 0, \ \   \\
&\bar x_0(\tau)\ge 0, \ \ \tau= \overline{t,t+T}, \\
&\bar U^+(\tau)\ge 0, \ \   \\
&\bar U^-(\tau)\ge 0, \ \ \tau= \overline{t,t+T-1}, \\
&\frac{\bar x_k(t+T)}{\sum_{i=0}^N \bar x_i(t+T)} = \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \  k= \overline{0,N}.
\end{split}
\end{equation}

Поясним смысл введенного ограничения
$$
\frac{\bar x_k(t+T)}{\sum_{i=0}^N \bar x_i(t+T)} = \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \  k= \overline{0,N}.
    $$
Здесь требуется, чтобы в момент времени $t+T$ пропорции
в портфеле вернулись к тем, что были в нулевой момент времени.
Идея данного подхода совпадает с той, что используется в
экономическом MPC с той лишь разницей, что в стандартных схемах экономического МРС в качестве устойчивого состояния
используется точка $x_s$, а в данном случае это целый луч, содержащий значения с одинаковыми пропорциями.


Предлагаемый  подход, кроме того, дает возможность
сравнивать эффективность управления MPC без учета
колебания курсов, поскольку отношения стоимостей
портфелей с тривиальным управление, и с управлением MPC, если они содержат
одинаковые пропорции, не зависит от текущих курсов.

В общем случае, терминальные ограничения
в форме равенства являются нежелательными для задач
MPC, так как, нахождение допустимого управления численными методами может быть затруднительно. 
В следующей теореме покажем, что для рассматриваемой задачи
MPC можно в явном виде указать допустимое управление.


\begin{theorem}\label{t1}
Задача (\ref{term_reg1}) -- (\ref{my_term_reg2}) разрешима.
\end{theorem}
\begin{proof}
Докажем, что всегда существует допустимое управление, которое
приведет портфель на шаге $T$ к необходимым пропорциям.
Докажем даже более строгое утверждение, можно за один 
шаг привести портфель к любым пропорциям. Этого будет
достаточно, так как можно на протяжении $T-1$ шагов
использовать тривиальное управление, а последним
шагом привести пропорции к заданным.

Пусть состояние системы в момент времени $t$ равно $(x_0(t), X(t))$, целью будет
получить пропорции как в $(x_0(0), X(0))$. Не нарушая общности
будем считать, что $x_0(0) + \sum_{i=1}^N X_i(0) = 1$.

При $x_0(0)=1$ допустимым будет управление

$$
	\bar U^-(t|t) = X(t), \ \ \ \\
	\bar U^+(t|t) = 0,
	$$
	
$$
 	\bar U^-(t+k|t) = X(t), \ \ \ \\
	\bar U^+(t+k|t) = 0,\ \ \ k = \overline{1,T-1}.
$$

Если $x_0(0) \neq 1$, то существует хотя бы один $j = \overline{1,N}$ 
такой, что $X_j(0) \neq 0$. В этом случае рассмотрим управление

$$
	\bar U^- = X(t), \\
	\bar U^+ = \alpha X(0),
	$$
	
для некоторого $\alpha \ge 0$. Тогда

$$
	\bar X(t+1) = \alpha X(0),
$$
$$
	\bar x_0(t+1)  = x_0(t) + S(t)^T X(t) - \alpha B(t)^T X(0).
$$

Найдем, чему будут равны пропорции при таком управлении:




\begin{equation}\label{eq:t1_x_0}
\frac{x_0(t+1)}{\sum_{i=0}^N x_i(t+1)} = \frac{x_0(t) + S(t)^T X(t) - \alpha B(t)^T X(0)}{x_0(t) + S(t)^T X(t) - \alpha B(t)^T X(0) + \alpha \sum_{i=0}^N x_i(0)}.
\end{equation}


При $\alpha = 0$ значение выражения
(\ref{eq:t1_x_0}) равно $1$, при росте $\alpha$ дробь
неограничено убывает. В силу непрерывности следует, что 
существует такое значение $\alpha$, что (\ref{eq:t1_x_0})
станет равной $x_0(0) \in [0,1)$.

При таком $\alpha$ будут выполняться и остальные пропорции

\begin{equation}\label{eq:t1_x_k}
\frac{x_k(t+1)}{\sum_{i=0}^N x_i(t+1)} = x_k(0), \ \  k= \overline{1,N}.
\end{equation}

Легко показать, что значение $\max_{U^+, U^-} J(x_0, X_0,U^+,U^-)$ ограничено. Это следует из того, что множество 
значений, которые могут принимать $(U^+, U^-)$ компактно.
Следовательно,  задача (\ref{term_reg1}) -- (\ref{my_term_reg2}) разрешима. \proofend
\end{proof}


\begin{theorem}
Пусть для начальных условий $x_0(0),X(0)$ по задаче  (\ref{term_reg1}) -- (\ref{my_term_reg2}) получено управление MPC
$$
    \{(U^{MPC}_+(0), U^{MPC}_-(0)), (U^{MPC}_+(1), U^{MPC}_-(1)), \dots\},
    $$
и соответствующая ей траектория
$$\{(X(0), x_0(0)), (X^{MPC}(1), x_0^{MPC}(1)), \dots \}$$
тогда любого $t \in \mathbb{Z}_+$ верно:
$$\max_{U^+, U^-} J(X^{MPC}(t), x^{MPC}_0(t),U^+, U^-) \ge x_0(0) + S(t+T)^T X(0).$$
\end{theorem}

\begin{proof}
Пусть в момент времени $j$ оптимальное управление
для задачи (\ref{term_reg1}) -- (\ref{my_term_reg2})
и соответствующая ему траектория равна

\begin{equation}\label{eq:t2_def}
\begin{split}
   \{(U^*_+(j|j), U^*_-(j|j))&, (U^*_+(j+1|j), U^*_-(j+1|j)), \dots, \\
   &(U^*_+(j+T-1|j), U^*_-(j+T-1|j))\}, \\
   \{(X^*(j|j), x_0^*(j|j))&, (X^*(j+1|j), x_0^*(j+1|j)), \dots, \\
   &(X^*(j+T|j), x_0^*(j+T|j))\}.
\end{split}
\end{equation}

Отметим, что по условию теоремы верны равенства
$$
	(X^*(j|j), x_0^*(j|j)) = (X^{MPC}(j), x_0^{MPC}(j)),
	$$
$$
	(U^*_+(j|j), U^*_-(j|j)) = (U^{MPC}_+(j), U^{MPC}_-(j)).
	$$
и, как следствие, верно равенство
$$
	(X^*(j+1|j), x_0^*(j+1|j)) = (X^{MPC}(j+1), x_0^{MPC}(j+1)).
	$$

Доказательство будем вести по индукции. База:
$$\max_{U^+, U^-} J(X(0), x_0(0),U^+, U^-) \ge x_0(0) + S(T)^T X(0).$$
верна из самого определения задачи 
(\ref{term_reg1}) -- (\ref{my_term_reg2}).

Предположим, что теорема верна для некого $j\ge 0$,
докажем для $j+1$. Из предположении индукции верно

$$\max_{U^+, U^-} J(X^{MPC}(j), x^{MPC}_0(j),U^+, U^-) \ge x_0(0) + S(j+T)^T X(0).$$

При этом из (\ref{eq:t2_def}) выполняется равенство 
\begin{equation}\label{eq:t2_max}
\max_{U^+, U^-} J(X^{MPC}(j), x^{MPC}_0(j),U^+, U^-)
= x^*_0(j+T|j) + S(j+T)^T X^*(j+T|j)
\end{equation}


Из терминального условия (\ref{my_term_reg2}) следует,
что существует $\beta$ такая, что

\begin{equation}\label{eq:t2_beta}
\begin{split}
&x^*_0(j+T|j) = \beta x_0(0), \\
&X^*(j+T|j) = \beta X(0).
\end{split}
\end{equation}

Из (\ref{eq:t2_max}) и (\ref{eq:t2_beta}) следует,
что $\beta \ge 1$.

Оценим значение
$$\max_{U^+, U^-} J(X^{MPC}(j+1), x^{MPC}_0(j+1),U^+, U^-)$$.

Рассмотрим управление

$$\{(U^*_+(j+1|j), U^*_-(j+1|j)),  \dots\, (U^*_+(j+T-1|j), U^*_-(j+T-1|j)), (0, 0)\}.
$$

Ему будет соответствовать траектория 

$$
	\{(X^*(j+1|j), x^*_0(j+1|j)),  \dots \, (X^*(j+T|j), x_0^*(j+T|j)), (X^*(j+T|j), x^*_0(j+T|j))\}.
	$$
	
Следовательно 
$$\max_{U^+, U^-} J(X^{MPC}(j+1), x^{MPC}_0(j+1),U^+, U^-) \ge x^*_0(j+T|j) + S(j+T+1)^T X^*(j+T|j)$$

Сделаем замену (\ref{eq:t2_beta}), получим

$$\max_{U^+, U^-} J(X^{MPC}(j+1), x^{MPC}_0(j+1),U^+, U^-) \ge \beta x_0(0) + \beta S(j+T+1)^T  X(0)$$.

Доказательство индукционного шага завершает то,
что $\beta \ge 1$. 
\proofend
\end{proof}


Данная теорема утверждает,  что в любой момент времени
портфель, управляемый MPC за $T$ шагов, может быть приведен
в терминальное множество и при этом стоимость портфеля будет
не меньше, чем в случае, когда постоянно используется тривиальное управление (инвестор не управляет портфелем).

Приведем пример того, как будет вести себя система при управлении МРС-регулятором, использующим задачу оптимального управления
с терминальным множеством и регуляризацией. На рисунке \ref{fig:det_regul_term_sin} представлен результат численного эксперимента для сгенерированных данных.
Как видно, в результате стоимость портфеля получается меньше,
нежели в случае без терминального множества (рисунок
\ref{fig:det_regul_sin}). Но при этом \`уже диапазон, в
котором изменяется количество ценных бумаг каждого
типа.


Аналогичные результаты получаем и для реальных данных
(рисунок \ref{fig:det_regul_term_real} по сравнению
с рисунком \ref{fig:det_reg}).

\begin{figure}[!h]
\begin{subfigure}{0.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figs/det_regul_term_sin}
  \caption{Сгенерированные данные}
  \label{fig:det_regul_term_sin}
\end{subfigure}
\begin{subfigure}{0.9\textwidth}
  \centering
  \includegraphics[width=\linewidth]{figs/det_reg_ter}
  \caption{Реальные данные}
  \label{fig:det_regul_term_real}
\end{subfigure}
\caption{Модель с регуляризацией и терминальным множеством}
\end{figure}

\section{Выводы}

В данной главе рассмотрена детерминированная модель портфеля. 
При исследовании влияния регуляризации
выявлено уменьшение доходности, но при 
этом и управление становится более гладким,
это демонстрируется на рисунках \ref{fig:det_no_reg} и \ref{fig:det_reg}.
Добавление к регуляризации терминального
множества еще сильнее сокращает прибыль, но так
же и заметно уменьшает диапазон, в котором происходят изменения количества ценных бумаг 
(рисунки \ref{fig:det_reg} и 
\ref{fig:det_regul_term_real}).

Доказана разрешимость задачи (\ref{term_reg1}) -- (\ref{my_term_reg2}). Кроме того, для данной задачи доказана эффективность управления MPC.

В целом, результаты данной главы показывают, 
что MPC предоставляет различные способы
для моделирования задачи формирования портфеля
и при этом позволяет учитывать множество
факторов, таких как разные курсы на покупку и
продажу, нежелание вносить большие изменения 
в структуру портфеля и возможность быстро
вернуться к исходным пропорциям. Кроме того,
эксперименты показывают, что скорость построения
управления достаточна для прикладного
использования.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{МОДЕЛИ С ПРОГНОЗАМИ}\label{sec:nondet}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В настоящей главе исследован случай, когда точно не известны будущие стоимости активов, и модель должна оперировать прогнозируемыми
значениями на заданном горизонте планирования $T$.

\section{Предсказание функций стоимости}

В общем случае, значения $S(t)$ и $B(t)$ в будущие
моменты времени не известны. В настоящей работе будем прогнозировать будущие значения на основе предыдущих наблюдений.

В работе используется линейная регрессионная модель \cite{Strizhov}, зависимости стоимости от времени. В этом пункте будет дано краткое теоретическое ее описание и пример использования для приближенного нахождения будущих значений.

Линейная регрессия --- метод восстановления зависимости между двумя переменными.

Пусть даны предыдущие наблюдениям за стоимостями
фиксированной бумаги $(p_1, p_2, \dots, p_m)$ в 
моменты времени $(t_1, t_2, \dots, t_m)$. 

Для заданного множества из $m$ пар $(t_i, p_i)$, $i=1,\ldots, m$, значений свободной и зависимой переменной требуется построить зависимость. Назначена линейная модель
$$
    p_i= f(\mathbf{w},t_i) + \varepsilon_i
    $$
c линейной функцией $f$ и аддитивной случайной величиной $\varepsilon$. Переменные $t$, $p$ принимают значения на числовой прямой $\mathbb{R}$.

Определим модель зависимости как

$$p_i= w_1 + w_2t_i + \varepsilon_i.$$

Согласно методу наименьших квадратов, искомый вектор параметров $\mathbf{w}=(w_1,w_2)^T$ есть решение нормального уравнения
$$
    \mathbf{w} = (A^TA)^{-1}A^T\mathbf{P},
    $$
где $\mathbf{P}$ — вектор, состоящий из значений зависимой переменной: $\mathbf{P}=(p_1,\ldots, p_m)$. Столбцы матрицы $A$ есть подстановки значений свободной переменной $t_i\mapsto a_{i}$,
 $i=1,\ldots, m$. Матрица имеет вид

$$A =\left(\begin{array}{cc} 1 & t_1\\ 1 & t_2\\ \ldots & \ldots \\ 1 & t_m\\ \end{array} \right).$$

Зависимая переменная восстанавливается по полученным весам и заданным значениям свободной переменной
$$
    p^*_i = w_1+w_2t_i,
    $$
иначе
$$
    \mathbf{P}^* = A\mathbf{w}.
    $$

Для оценки качества модели используется критерий суммы квадратов регрессионных остатков, SSE --- Sum of Squared Errors.
$$
    SSE = \sum_{i=1}^m(p_i-p_i^*)^2 = (\mathbf{P}-\mathbf{P}^*)^T(\mathbf{P}-\mathbf{P}^*).
    $$


\subsection{Оценка предсказания функций стоимости}\label{sec:pred_eval}

В данном пункте рассматривается вопрос о качестве найденных оценок \cite{Borovkov}. Находится их смещение, вычисляется распределение и дисперсия ошибки.


Для нахождения математического ожидания и вариации ошибки будем использовать
встроенные {\sl Matlab} функции {\sl var}, {\sl mean}.
Данные функции вычисляют следующие значения:
$$  
    \mu = \frac{1}{N}\sum_{i=1}^N A_i,
    $$
$$
    V = \frac{1}{N-1} \sum_{i=1}^{N} |A_i - \mu|^2.
    $$

В процессе прогнозирования вычисляется ошибка следующим образом
$$
    e_i = \frac{p_i-p_i^*}{p_i}.
    $$

Данная ошибка была подсчитана для прогнозирования 
стоимости криптовалют от одного до шести шагов вперед.
На рисунке~\ref{fig:pred} изображены распределения ошибок прогнозирование будущих стоимостей продаж ценных
бумаг.

\begin{figure}[t!]
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred1}
  \caption{На 1 шаг}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred2}
  \caption{На 2 шага}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred3}
  \caption{На 3 шага}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred4}
  \caption{На 4 шага}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred5}
  \caption{На 5 шагов}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred6}
  \caption{На 6 шагов}
\end{subfigure}
\caption{Распределение ошибок предсказания}
\label{fig:pred}
\end{figure}

В таблице~\ref{t:err} приведены численные значения
математического ожидания и вариации для предсказаний.


\begin{table}
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
t & mean & var \\ \hline
1 & 0.0007 & 0.0036 \\ \hline
2 & 0.0007 & 0.0083  \\ \hline
3 & 0.0012 & 0.0162 \\ \hline
4 & 0.0032 & 0.0265 \\ \hline
5 & 0.0043 & 0.0389 \\ \hline
6 & 0.0064 & 0.0545 \\ \hline
\end{tabular}
\caption{Ошибки прогнозирования}\label{t:err}
\end{center}
\end{table}


Дисперсия $D[e(t)]$ будет в дальнейшем использоваться для функции стоимости этапа.

Так как значения математического ожидания, представленные
в таблице \ref{t:err}, близки к нулю, то будем считать,
что полученные оценки являются несмещенными.

\section{Модели с регуляризацией}

Покажем, что для недетерминированного случая
нельзя просто использовать предсказания без 
использования регуляризации.

На рисунке \ref{fig:nodet_no_reg_no_term} представлен
такой случай, при этом на нижнем графике видно, что
стоимость портфеля при тривиальном управлении будет
выше, чем при управлении MPC.

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/no_det_no_term_not_regul}
  \caption{Недетерминированная модель без регуляризацией}
  \label{fig:nodet_no_reg_no_term}
\end{figure}

Представленное на рисунке \ref{fig:nodet_no_reg_no_term} снижение стоимости
портфеля связано с тем, что управление строится на основе
прогнозируемых данных, и при этом одинаково учитывается
весь горизонт планирования. Введем способ регуляризации, предложенный в статье \cite{Hewing} который позволит модели учитывать
вероятностную природу прогнозируемых данных.

Введем функцию
стоимости этапа, которая будет учитывать ошибки
прогнозирования.

В том случае, когда точно не известны значения $s_i(t)$ и $b_i(t)$,
функция перехода для $x_0(t)$, в соответствии
с (\ref{eq:det2}) имеет следующий вид:

\begin{equation}\label{def:x_0_nodet}
x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t),
\end{equation}

где $$B(t) = (I + E_1(t))\bar B(t).$$
В представленной формуле $\bar B(t)$ --- прогнозируемое значение, $I$ -- единичная
матрица, $E_1(t)$ -- случайная диагональная матрица ошибок, при этом $M[E_1(t)] = 0$ (пункт \ref{sec:pred_eval}). Аналогично

$$S(t) = \bar S(t)(1 + E_2(t)).$$

Поскольку изменение цены покупки и продажи происходит одинаково, то будем считать,
что $E_1(t)\equiv E_2(t) = E(t)$.

Сейчас перепишем (\ref{def:x_0_nodet}) с учетом
вида функций $B$ и $S$:

\begin{equation}
\begin{split}
x_0(t+1) &= x_0(t) - \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t) - \\
&- \left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t).
\end{split}
\end{equation}

Оценим для величины $x_0(t+1)$ математическое ожидание и дисперсию:

\begin{equation}\label{ned_exp}
M[x_0(t+1)] = M[x_0(t)] + \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t).
\end{equation}

Будем считать, что величины $x_0(t)$ и $W(t)$ независимы, кроме того, стоимости активов не коррелируют
\begin{equation}
\begin{split}
D[x_0(t+1)] &= D[x_0(t) - \left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t)]= \\
 &=D[x_0(t)] + D[\left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t)]\le \\
 &=D[x_0(t)] + ((\bar B(t)^T D[E(t)])^T U^+(t))^2 + ((\bar S(t)^T D[E(t)])^T U^-(t))^2.
\end{split}
\end{equation}

Сейчас внесем учет дисперсии в функцию перехода, эта добавка будет служить
своего рода ограничением дисперсии при максимизации математического ожидания. Введем функцию стоимости
этапа следующим образом:

\begin{equation}
L_t(U^+(t),U^-(t)) = \alpha\left( ((\bar B(t)^T D[E(t)])^T U^+(t))^2 + ((\bar S(t)^T D[E(t)])^T U^-(t))^2\right).
\end{equation}


Оценки на значения $D[E(t)]$ зависят от способа предсказания векторов $\hat S(t)$ и $\hat B(t)$.

Теперь задача MPC имеет вид:

\begin{equation}\label{term_reg}
\begin{split}
&\max_{U^+, U^-} -\sum_{\tau=0}^{T-1} L_t(U^+(t+\tau),U^-(t+\tau)) + \\
&\ \ \ \ \ \ \ \ \ \ + \bar x_0(t+T) + \hat S(t_0+T)^T \bar X(t+T),  \\
&\bar X(\tau + 1) = \bar X(\tau) + U^+(\tau) - U^-(\tau), \\
&\bar x_0(\tau+1) = \bar x_0(\tau) - \hat B(\tau)^T \bar U^+(\tau) + \hat S(\tau)^T \bar U^-(\tau),  \\
&\bar X(t) = X(t), \\
&\bar x_0(t) = x_{0}(t), \\
&\bar X(\tau)\ge 0, \ \   \\
&\bar x_0(\tau)\ge 0, \ \ \tau= \overline{t,t+T}, \\
&\bar U^+(\tau)\ge 0, \ \   \\
&\bar U^-(\tau)\ge 0, \ \ \tau= \overline{t,t+T-1}.
\end{split}
\end{equation}


\begin{theorem}
Задача (\ref{term_reg}) разрешима.
\end{theorem}
\begin{proof}
Доказательство аналогично доказательству теоремы \ref{t1}.
\proofend
\end{proof}


Результат применения представлен
на рисунке \ref{fig:nodet_reg_term}. Тут видим, что
применение управления MPC уже лучше, нежели
тривиальное управление.

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/nodet_term_reg}
  \caption{Модель с регуляризацией}
  \label{fig:nodet_reg_term}
\end{figure}

Стоит отметить, что в части работ, посвященных
управлению портфелем, например в \cite{Marigo}, 
делается допущение, что стоимость покупки и продажи совпадают.
Это допущение является очень сильным и приводит
к тому, что в отличии ситуации на рисунке 
(\ref{fig:nodet_no_reg_no_term}) при равных
стоимостях покупки и продажи получаем ситуацию как
на рисунке
(\ref{fig:nodet_no_reg_no_term_s_b}), где модель
не нуждается ни в регуляризации, ни в терминальном 
множестве.

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/no_det_no_term_not_regul_s_b}
  \caption{Недетерминированная модель без регуляризации\\при равных стоимостях продажи и покупки}
  \label{fig:nodet_no_reg_no_term_s_b}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Модель с терминальным условием}\label{sec:termin}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В данном пункте рассмотрим дополнительные ограничения
для модели, введем терминальное множество
и рассмотрим задачу квазибесконечного MPC.

Выберем $\epsilon\in[0,1]$, и модифицируем
терминальное множество из модели (\ref{term_reg1})-(\ref{my_term_reg2}) следующим образом:

$$
    \left|\frac{\bar x_k(t+T)}{\sum_{i=0}^N \bar x_i(t+T)} - \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}\right| \le \epsilon, \ \  k= \overline{0,N}.
    $$
    
Идея данного ограничения возникает из того, что 
инвестор может хотеть не сильно отдалятся, от 
изначальных пропорций, но при этом все еще увеличить
свой доход относительно тривиального управления.

Задача MPC формулируется следующим образом:

\begin{equation}\label{nodet_term_reg1}
\begin{split}
\max_{U^+, U^-} &-\sum_{\tau=0}^{T-1} L_t(U^+(t+\tau),U^-(t+\tau)) + \\
&+ \bar x_0(t+T) + \hat S(t_0+T)^T \bar X(t+T),  \\
\end{split}
\end{equation}
при условиях
\begin{equation}\label{nodet_term_reg2}
\begin{split}
&\bar X(\tau + 1) = \bar X(\tau) + U^+(\tau) - U^-(\tau), \\
&\bar x_0(\tau+1) = \bar x_0(\tau) - \hat B(\tau)^T \bar U^+(\tau) + \hat S(\tau)^T \bar U^-(\tau),  \\
&\bar X(t) = X(t), \\
&\bar x_0(t) = x_{0}(t), \\
&\bar X(\tau)\ge 0, \ \   \\
&\bar x_0(\tau)\ge 0, \ \ \tau= \overline{t,t+T}, \\
&\bar U^+(\tau)\ge 0, \ \   \\
&\bar U^-(\tau)\ge 0, \ \ \tau= \overline{t,t+T-1}, \\
&\left|\frac{\bar x_k(t+T)}{\sum_{i=0}^N \bar x_i(t+T)} - \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}\right| \le \epsilon, \ \  k= \overline{0,N}.
\end{split}
\end{equation}


\begin{theorem}
Задача (\ref{nodet_term_reg1}) - (\ref{nodet_term_reg2}) разрешима.
\end{theorem}
\begin{proof}
Доказательство аналогично доказательству теоремы \ref{t1}.
\proofend
\end{proof}



На рисунке \ref{fig:nodet_term_reg_a_35} представлен
эксперимент с $\epsilon = 0.35$. Как видно, пропорции
между количеством активов первого и второго типа
достаточно близко к изначальным на протяжении всего
времени.

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/nodet_term_reg_a_35}
  \caption{Недетерминированная модель с регуляризацией и терминальным множеством}
  \label{fig:nodet_term_reg_a_35}
\end{figure}

\section{Выводы}



В данной главе рассмотрено формирование портфеля при использовании прогнозированных цен.
Исследованы числовые характеристики предложенного способа прогнозирования стоимостей. 

В ходе экспериментов показано, что приравнивание цены
покупки и продажи является довольно существенным
допущением и необходимо ставить эксперименты
с разными стоимостями на покупку и продажу. Кроме того, использование модели без регуляризации 
(\ref{eq:det1}) - (\ref{eq:det2}) тоже
неэффективно и может вести себя
даже хуже, чем тривиальное управление.

Предложен модифицирован способ 
регуляризации с учетом полученных оценок для
прогнозируемых стоимостей. Так же в
задаче (\ref{my_term_reg2}) терминальное множество, модифицировано в терминальное условие (\ref{nodet_term_reg2}), что упрощает ее численное решение. Для всех модификаций составлены
и рассмотрены задачи MPC, проведены численные эксперименты. Эти эксперименты показывают, что
полученная модель дает больше прибыли, нежели
тривиальное управление.


\chapter*{ЗАКЛЮЧЕНИЕ}

В данной работе рассмотрены модели портфеля
с детерминированными и прогнозируемыми стоимостями активов. Исследовано влияние
регуляризации и терминальных условий на
управление и соответствующую доходность.

Доказана разрешимость задачи (\ref{term_reg1}) -- (\ref{my_term_reg2}). Кроме того, для данной задачи доказана эффективность управления MPC.

В работе показано, 
что MPC предоставляет различные способы
для моделирования задачи формирования портфеля
и при этом позволяет учитывать множество
факторов, таких как разные курсы на покупку и
продажу, нежелание вносить большие изменения 
в структуру портфеля и возможность быстро
вернуться к исходным пропорциям. Кроме того,
эксперименты показывают, что скорость построения
управления достаточна для прикладного
использования.

При использовании прогнозируемых стоимостей, предложен модифицирован способ 
регуляризации с учетом полученных оценок для
прогнозируемых цен. Для всех модификаций составлены
и рассмотрены задачи MPC, проведены численные эксперименты.

Новизной данной работы является подход к использованию
прогнозируемых стоимостей покупки и продажи бумаг.
При этом подходе сама модель допускает разные цены
на покупку и продажу, кроме того, выделение прогнозирования
в отдельную подзадачу позволило составить универсальную
модель MPC, не зависящую от способа прогнозирования.
Таким образом, сейчас на улучшение качества управления
можно влиять при помощи построения более точных
оценок стоимостей бумаг.

В дальнейших исследованиях планируется попробовать заменить модель прогнозирования на более совершенныю, 
например LSTM нейронную сеть. Исследовать, какие
дополнительные ограничения необходимо наложить на
функции $S(t)$ и $B(t)$ чтоб получить доказуемо 
лучшее тривиального управление.

