\chapter{Динамические модели портфельной оптимизации}

В настоящей главе вводятся основные понятия и определения, строятся математические модели, описывающие динамику инвестиционного портфеля, и формулируются задачи его оптимизации. Рассматриваемые модели можно разбить на два класса: детерминированные, в которых заданы функции цены покупки и продажи ценных бумаг, и недетерминированные, в которых указанные функции прогнозируются на заданном горизонте планирования. Описываются данные, которые будут использоваться для проведения численных экспериментов, и методы прогнозирования. Обсуждаются достоинства и недостатки различных подходов при оптимизации портфелей.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Основные положения модели}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


Портфель --- совокупность инвестиционных вложений, состоящих из ценных бумаг и
свободных финансов.

Портфель состоит из $N$ типов бумаг. Количество бумаг $i$-го типа ($i = \overline{1,N}$) в момент времени $t\ge t_0$ равняется $x_i(t)$, где $x_i(t)\ge 0$.
Обозначим через $x_0(t)$ --- количество свободных финансов в момент времени $t\ge t_0$.

Через $u^+_i(t)$ будем обозначать количество  ценных бумаг типа $i$, которые инвестор купил в момент времени
$t$. Соответственно, через $u^-_i(t)$ обозначим, сколько инвестор продал
ценных бумаг типа $i$ в момент времени $t$. Пусть стоимость
покупки $i$-ой бумаги равна $b_i(t)\ge 0$ (buy), а продажа $s_i(t)\ge 0$ (sell). Конкретный вид функций $s_i(t)$, $b_i(t)$, $t\ge t_0$ будет обсуждаться ниже, в разделе~\ref{secXX}.

Таким образом, на в момент времени $t$ инвестор покупает ценных бумаг типа $i$ на сумму $b_i(t)u^+_i(t)$ и продает на сумму $s_i(t)u^-_i(t)$.

Тогда количество свободных средств в следующий момент времени $t+1$ будет
равно
\begin{equation}\label{eq:x0}
    x_0(t+1) = x_0(t) + \sum_{i=1}^N
        \left( -u^+_i(t)b_i(t) + u^-_i(t)s_i(t)\right).
\end{equation}


Количество ценных бумаг типа $i$ в момент времени $t+1$
будет равно
\begin{equation}\label{eq:xi}
    x_i(t+1) = x_i(t) + u^+(i) - u^-(i).
\end{equation}

Считаем, что в начальный момент времени $t_0$ заданы начальные условия --- количество бумаг каждого типа и объем свободных средств, которыми располагает инвестор:
$$
    x_i(t_0) = x_{i0}, \ i=\overline{1,N}; \ \ x_0(t_0) = x_{00}.
    $$

Введенные переменные и уравнения (\ref{eq:x0}), (\ref{eq:xi}) представим в векторной форме. Введем следующие векторы:
\begin{equation}\label{eq:vec}
\begin{split}
& X(t) = [x_1(t),x_2(t),\dots,x_N(t)]^T; \\
& U^+(t)=[u^+_1(t),\dots,u^+_N(t)]^T; \\
& U^-(t)=[u^-_1(t),\dots,u^-_N(t)]^T; \\
& B(t)=[b_1(t),\dots,b_N(t)]^T; \\
& S(t)=[s_1(t),\dots,s_N(t)]^T; \\
& X_0=[x_{10},\dots,x_{N0}]^T.
\end{split}
\end{equation}

Используя (\ref{eq:vec}), перепишем (\ref{eq:xi}) для $X(t)$:
\begin{equation}\label{eq:Xvec}
    X(t+1) = X(t) + U^+(t) - U^-(t),  \ \ X(t_0) = X_0,  \ \ t\ge t_0.
\end{equation}


Представим (\ref{eq:x0}) в векторной форме:
\begin{equation}\label{eq:x0vec}
    x_0(t+1) = x_0(t) +  B(t)^T U^+(t) -  S(t)^T U^-(t), \ \ x_0(t_0) = x_{00}, \ \ t\ge t_0.
\end{equation}



На значения $X(t)$, $x_0(t)$, $U^+(t)$, $U^-(t)$  в каждый момент времени $t$ накладываются следующие естественные ограничения:
\begin{equation}\label{eq:constr}
 \begin{split}
    & X(t)\ge 0,\\
    & x_0(t)\ge 0, \\
    & U^+(t)\ge 0,\\
    & U^-(t)\ge 0, \\
    & t\ge t_0.\\
 \end{split}
\end{equation}

С точки зрения теории оптимального управления, в динамической модели (\ref{eq:Xvec}) --  (\ref{eq:constr}): переменные $X(t)\in \mathbb{R}^N$, $x_0(t)\in \mathbb{R}$ --- фазовые переменные (зависимые), переменные $U^+(t)\in \mathbb{R}^N$, $U^-(t)\in \mathbb{R}^N$ --- управляющие переменные (управления, независимые), динамическая модель нестационарная в силу зависимости от времени функций цены покупки $B(t)$, $t\ge t_0$, и цены продажи $S(t)$, $t\ge t_0$. Ограничения (\ref{eq:constr}), накладываются как на управляющие, так и на фазовые переменные.

\bigskip

Введем понятие общей стоимости портфеля.

Пусть $w_i(t)$ --- общая стоимость бумаг типа $i$, и она равна сумме, которую
инвестор  может выручить из ее продажи в момент времени $t$: 
$$
    w_i(t) = s_i(t) x_i(t), \ \ t\ge t_0.
    $$
Значение $w_0(t)$ будем считать равным $x_0(t)$. Тогда общая стоимость портфеля равна 
$$
    w(t) = \sum_{i=0}^N w_i(t).
    $$

В векторном виде, используя (\ref{eq:vec}), получим следующую формулу для общей стоимости портфеля:
$$
    w(t) = x_0(t) +  S(t)^T X(t).
    $$
    
Задачи оптимизации портфеля, динамика которого описывается согласно (\ref{eq:Xvec}), (\ref{eq:x0vec}) и подчиняется ограничениям (\ref{eq:constr}) будет связана с максимизацией введенной стоимости портфеля при различных дополнительных требованиях. Первая такая модель будет рассмотрена в разд.~\ref{sec:detmodel}, а до этого опишем данные, которые будут использоваться для численных экспериментов.


\subsection{Данные для численных экспериментов}

В данном пункте будут описаны данные, которые используются для проведения численных экспериментов, а также приводится описание того,
как строятся прогнозы для значений функций цен $S(t)$,
$B(t)$, $t\ge t_0$, при рассмотрении недетерминированной модели (см. разд.~\ref{sec:nondet}), когда их точные значения не известны заранее.

Будем работать с двумя типами данных:
\begin{enumerate} 
\item сгенерированных искусственно; 
\item реальными котировками на рынке криптовалют.
\end{enumerate}

Сгенерированные данные представляют собой сумму линейной и синусоидальной функции
\begin{equation}\label{eq:sin_gen}
\begin{split}
&b_i(t) = k_{i0} + k_i t + \alpha_i \sin(r_i + g_i t); \\
&s_i(t) = 0.99 b_i(t).
\end{split}
\end{equation}


Для (\ref{eq:sin_gen}) значения $k_{i0}$, $k_i$, $\alpha_i$, $r_i$, $g_i$ подбираются таким образом, чтобы ни для
каких $i \neq j$ не совпадали периоды. Выбор функции $s_i(t)$ в представленном виде обусловлен тем наблюдением реально существующий картины, что разница между покупкой и продажей приблизительно равна фиксированному проценту, и таким образом, она будет хорошим приближением для используемых данных.

Реальные данные взяты из исторических курсов на
сайте {\it coinmarketcap.com} за период ...

Тут вставить графики функций {\bf (НЕ ЗАБЫТЬ ВСТАВИТЬ :)}

\subsection{Предсказание значений}

В общем случае, значения $S(t)$ и $B(t)$ в будущие
моменты времени не известны. В настоящей работе будем прогнозировать будущие значения на основе предыдущих наблюдений.

В работе используется линейная регрессионная модель \cite{Strizhov}, зависимости стоимости от времени. В этом пункте будет дано краткое теоретическое ее описание и пример использования для приближенного нахождения будущих значений.

Линейная регрессия --- метод восстановления зависимости между двумя переменными.

Пусть даны предыдущие наблюдениям за стоимостями
фиксированной бумаги $(p_1, p_2, \dots, p_m)$ в 
моменты времени $(t_1, t_2, \dots, t_m)$. 

Для заданного множества из m пар $(t_i, p_i)$, $i=1,\ldots, m$, значений свободной и зависимой переменной требуется построить зависимость. Назначена линейная модель
$$
    p_i= f(\mathbf{w},t_i) + \varepsilon_i
    $$
c линейной функцией $f$ и аддитивной случайной величиной $\varepsilon$. Переменные $t$, $p$ принимают значения на числовой прямой $\mathbb{R}$.

Определим модель зависимости как

$$p_i= w_1 + w_2t_i + \varepsilon_i.$$

Согласно методу наименьших квадратов, искомый вектор параметров $\mathbf{w}=(w_1,w_2)^T$ есть решение нормального уравнения
$$
    \mathbf{w} = (A^TA)^{-1}A^T\mathbf{P},
    $$
где $\mathbf{P}$ — вектор, состоящий из значений зависимой переменной: $\mathbf{P}=(p_1,\ldots, p_m)$. Столбцы матрицы $A$ есть подстановки значений свободной переменной $t_i^0\mapsto a_{i1}$ и $t_i^1\mapsto a_{i2}$,
 $i=1,\ldots, m$. Матрица имеет вид

$$A =\left(\begin{array}{cc} 1 & t_1\\ 1 & t_2\\ \ldots & \ldots \\ 1 & t_m\\ \end{array} \right).$$

Зависимая переменная восстанавливается по полученным весам и заданным значениям свободной переменной
$$
    p^*_i = w_1+w_2t_i,
    $$
иначе
$$
    \mathbf{P}^* = A\mathbf{w}.
    $$

Для оценки качества модели используется критерий суммы квадратов регрессионных остатков, SSE --- Sum of Squared Errors.
$$
    SSE = \sum_{i=1}^m(p_i-p_i^*)^2 = (\mathbf{P}-\mathbf{P}^*)^T(\mathbf{P}-\mathbf{P}^*).
    $$


\subsection{Оценка прогнозирования}

В данном пункте рассматривается вопрос о качестве найденных оценок \cite{Borovkov}. Находится их смещение, вычисляется распределение и дисперсия ошибки.


Для нахождения математического ожидания и вариации ошибки будем использовать
встроенные {\sl Matlab} функции {\sl var}, {\sl mean}.
Данные функции вычисляют следующие значения:
$$  
    \mu = \frac{1}{N}\sum_{i=1}^N A_i,
    $$
$$
    V = \frac{1}{N-1} \sum_{i=1}^{N} |A_i - \mu|^2.
    $$

В процессе прогнозирования вычисляется ошибка следующим образом
$$
    e(t) = \frac{x_{predicted}(t)-x_{real}(t)}{x_{real}(t)}.
    $$

Данная ошибка была подсчитана для прогнозирования {\bf(УКАЗАТЬ КАКИЕ ДАННЫЕ)} от одного до шести шагов вперед.
На рисунке~\ref{fig:pred} изображены распределения ошибок прогнозирование будущих стоимостей продаж ценных
бумаг.

\begin{figure}[t!]
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred1}
  \caption{На 1 шаг}
  \label{fig:sfig1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred2}
  \caption{На 2 шага}
  \label{fig:sfig2}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred3}
  \caption{На 3 шага}
  \label{fig:sfig1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred4}
  \caption{На 4 шага}
  \label{fig:sfig2}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred5}
  \caption{На 5 шагов}
  \label{fig:sfig1}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{figs/pred6}
  \caption{На 6 шагов}
  \label{fig:sfig2}
\end{subfigure}
\caption{Распределение ошибок предсказания}
\label{fig:pred}
\end{figure}

В таблице~\ref{t:err} приведены численные значения
математического ожидания и вариации для предсказаний.


\begin{table}
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
t & mean & var \\ \hline
1 & 0.0007 & 0.0036 \\ \hline
2 & 0.0007 & 0.0083  \\ \hline
3 & 0.0012 & 0.0162 \\ \hline
4 & 0.0032 & 0.0265 \\ \hline
5 & 0.0043 & 0.0389 \\ \hline
6 & 0.0064 & 0.0545 \\ \hline
\end{tabular}
\caption{Ошибки прогнозирования}\label{t:err}
\end{center}
\end{table}


Дисперсия $D[e(t)]$ будет в дальнейшем использоваться для функции стоимости этапа, которая имеет вид
$$
    L_t(U^+(t),U^-(t)) = \alpha D[e(t)] \left(\bar B(t)^T U^+(t) + \bar S(t)^T U^-(t)\right)^2,
    $$
{\bf где $W(t)$ это собственно и сама ошибка прогнозирования.}

Так как значения математического ожидания, представленные
в таблице \ref{t:err}, близки к нулю, то будем считать,
что полученные оценки являются несмещенными {\bf (ВСТАВИТЬ ССЫЛКУ)}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Детерминированная модель}\label{sec:detmodel}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Настоящий раздел посвящен исследованию детерминированной модели оптимизации портфеля, т.е. случаю, когда в начальный момент времени $t_0$ точно известны все значения цены продажи и покупки $s_i(t)$ 
и $b_i(t)$, $t\ge 0$, $i = \overline{1,N}$.


Будем применять методы МРС, описанные в главе 1 для задачи оптимизации портфеля. При этом рассматриваются две прогнозирующие задачи МРС с конечным горизонтом прогнозирования $T$:

\begin{itemize}
\item задача максимизации стоимости портфеля без условий в терминальный момент времени $t_0+T$ (без терминального множества);
\item задача максимизации стоимости портфеля с условиями в терминальный момент времени $t_0+T$ (с терминальным множеством).
\end{itemize}

\subsection{Максимизация стоимости портфеля без терминального множества}

Рассмотрим следующую задачу MPC c горизонтом планирования $T$
\begin{equation}\label{eq:det1}
\begin{split}
\max_{U^+, U^-} J(X_0, x_{00},U^+, U^-) & = w(t_0+T) = \\ 
        & =  x_0(t_0+T)+S(t_0+T)^T X(t_0 + T),
\end{split}
\end{equation}
при условиях
\begin{equation}\label{eq:det2}
\begin{split}
&X(t+1) = X(t) + U^+(t) - U^-(t), \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t),  \\
&X(t_0) = X_0, \\
&x_0(t_0) = x_{00}; \\
&X(t)\ge 0, \ \   \\
&x_0(t)\ge 0, \ \ t= \overline{t_0,t_0+T}; \\
&U^+(t)\ge 0, \ \   \\
&U^-(t)\ge 0, \ \ t= \overline{t_0,t_0+T-1}.
\end{split}
\end{equation}

Отметим, что в  задаче оптимального управления (\ref{eq:det1}) -- (\ref{eq:det2}) функция стоимости не ограничена,
кроме того, тут отсутствует функция стоимости этапа $L_t(\cdot)$, а максимизируется только терминальная стоимость портфеля.

Так как предположение $J^{*}_{\infty}(X_0, x_{00},U^+, U^-) < \infty$ из главы~\ref{chap3} не выполняется, то невозможно  гарантировать устойчивость процесса, замкнутого обратной связью, построенной в результате применения MPC-алгоритма из главы~\ref{chap3} с прогнозирующей задачей оптимального управления  (\ref{eq:det1}) -- (\ref{eq:det2}). Также невозможно исследовать полученное решение на субоптимальность.

\bigskip

Приведем типичную картину поведения инвестора, использующего для управления портфелем задачу (\ref{eq:det1}) -- (\ref{eq:det2}). Для этого приведем результаты численных экспериментов для двух ценных бумаг ($N=2$) при горизонте прогнозирования $T=6$ и используя синтетические и реальные данные.

На рисунке \ref{fig:det_no_reg} представлены данные проведенного численного
эксперимента. Верхний график показывает количество
ценных бумаг первого и второго типа в каждый
момент времени. Нижний график представляет
собой общую стоимость базового портфеля (с тривиальным
управлением --- зеленая кривая) и стоимость портфеля под управлением MPC (красная кривая).

\begin{figure}[h!]
  \centering
  \includegraphics[width=\linewidth]{figs/det_no_regul}
  \caption{Детерминированная модель без регуляризации}
  \label{fig:det_no_reg}
  
  \includegraphics[width=\linewidth]{figs/det_regul}
  \caption{Детерминированная модель с регуляризацией}
  \label{fig:det_reg}
\end{figure}

Как видно из рисунка \ref{fig:det_no_reg}, при  использовании задачи  (\ref{eq:det1}) -- (\ref{eq:det2}) происходят частые операции вида: продать
все бумаги типа $i$ и на освободившиеся деньги купить
бумаги типа $j$, $i,j = 1,2$. Для инвестора такое поведение может приводить к проблемам, поскольку ему приходится постоянно перестраивать
портфель, что привносит в его поведение большие риски. Подробнее об этом будет
рассказано в главе с недетерминированной моделью.

\bigskip

Изменим критерий качества (\ref{eq:det1}), добавив  в него с целью регуляризации стоимость этапа $L(U^+(t), U^-(t))$. 

Получим следующую задачу
$$
    \min_{U^+, U^-} J(x,u) = \sum_{i=0}^T L(U^+(i), U^-(i)) - w(T),
    $$
при условиях (\ref{eq:det2}). Заметим, что здесь критерий качества минимизируется, стоимость портфеля взята за знаком $-$.

Если в качестве функции этапа взять, например, функцию вида
$$
    L(U^+(t), U^-(t)) = \alpha( B(t)^T U^+(t) + S(t)^T U^-(t))^2,
    $$
которая характеризует весь оборот денег, произошедший  в момент времени $t$, то графики изменятся (для $\alpha=0.01$) как представлено на рисунке \ref{fig:det_reg}.




\begin{figure}[t!]
  \centering
  \includegraphics[width=\linewidth]{figs/det_no_regul_sin}
  \caption{Детерминированная модель без регуляризацией}
  \label{fig:det_no_reg_sin}
%\end{figure}
%
%\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/det_regul_sin}
  \caption{Детерминированная модель с регуляризацией}
  \label{fig:det_regul_sin}
\end{figure}

Аналогичная картина получается в численных экспериментах со сгенерированными тестовыми данными. Без функции стоимости этапа результаты представлены на рисунке \ref{fig:det_no_reg_sin}, со
стоимостью этапа --- на рисунке \ref{fig:det_regul_sin}.


\subsection{Максимизация стоимости портфеля с терминальным множеством}

Рассмотрим теперь в качестве прогнозирующей задачи MPC  --- задачу оптимального управления с горизонтом планирования $T$ и ограничениями, накладываемыми на состав портфеля в терминальный момент времени $t_0+T$:
\begin{equation}\label{term_reg1}
\max_{U^+, U^-} J(x_0, X_0,U^+,U^-) = x_0(t_0+T) + X(t_0+T)^T S(t_0+T); \\
\end{equation}
при условиях
\begin{equation}\label{term_reg2}
\begin{split}
&\max_{U^+, U^-} J(x_0, X_0,U^+,U^-) = x_0(t_0+T) +  S(t_0+T)^T X(t_0+T); \\
&X(t+1) = X(t) + U^+(t) - U^-(t), \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t),  \\
&X(t_0) = X_0, \\
&x_0(t_0) = x_{00}; \\
&X(t)\ge 0,  \\
&x_0(t)\ge 0, \ \ t= \overline{t_0,t_0+T}; \\
&U^+(t)\ge 0, \\
&U^-(t)\ge 0,  \ \ t= \overline{t_0,t_0+T-1};\\
&\frac{x_k(t_0+T)}{\sum_{i=0}^N x_i(t_0+T)} = \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \  k= \overline{0,N}.
\end{split}
\end{equation}

Поясним смысл введенного ограничения
$$
    \frac{x_k(t_0+T)}{\sum_{i=0}^N x_i(t_0+T)} = \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \  k= \overline{0,N}.
    $$
Здесь требуется, чтобы в момент времени $t_0+T$ пропорции
в портфеле вернулись к тем, что были в нулевой момент времени.
Идея данного подхода совпадает с той, что используется в
экономическом MPC с той лишь разницей, что в стандартных схемах экономического МРС в качестве устойчивого состояния
используется точка $x_s$, а в данном случае это целый луч, содержащий значения с одинаковыми пропорциями.


Предлагаемый  подход, кроме того, дает возможность
сравнивать эффективность управления MPC без учета
колебания курсов, поскольку отношения стоимостей
портфелей с тривиальным управление, и с управлением MPC, если они содержат
одинаковые пропорции, не зависит от текущих курсов.

\begin{theorem}
Задача (\ref{term_reg1}) -- (\ref{term_reg2}) разрешима.
\end{theorem}
\begin{proof}
Заметим, что тривиальное управление
$$
    U^+(t)=U^-(t)\equiv 0,\ \  t= \overline{t_0,t_0+T-1},
    $$
является допустимым. Кроме того, при этом управлении значение функции $\max_{U^+, U^-} J(x_0, X_0,U^+,U^-)$ в (\ref{term_reg1}) {\bf(ПРОПУЩЕНА ФРАЗА)}, следовательно,  задача (\ref{term_reg1}) -- (\ref{term_reg2}) разрешима.
\end{proof}


\begin{theorem}
Пусть для начальных условий $x_{00},X_0$ из задачи  (\ref{term_reg1}) -- (\ref{term_reg2}) получено управление MPC
$$
    \{(U^+(0), U^-(0)), (U^+(1), U^-(1)), \dots\},
    $$
и соответствующая ей траектория
$$\{(\hat X(0), \hat x_0(0)), (\hat X(1), \hat x_0(1)), \dots \}$$
тогда любого $m \in \mathbb{Z}_+$ верно:
$$\max_{U^+, U^-} J(\hat X(m), \hat x_0(m),U^+, U^-) \ge x_0(0) + X(0)^T S(m+T).$$
\end{theorem}

Данная теорема утверждает,  что в любой момент времени
портфель, управляемый MPC за $T$ шагов, может быть приведен
в терминальное множество и при этом стоимость портфеля будет
не меньше, чем в случае, когда постоянно используется тривиальное управление (инвестор не управляет портфелем).

\begin{proof}
Будет добавлено позже {\bf(НЕ ЗАБЫТЬ ДОБАВИТЬ)}
\end{proof}


Приведем пример того, как будет вести себя система при управлении МРС-регулятором, использующим задачу оптимального управления
с терминальным множеством. На рисунке \ref{fig:det_regul_term_sin} представлен результат численного эксперимента для сгенерированных данных.
Как видно, в результате стоимость портфеля получается меньше,
нежели в случае без терминального множества (рисунок
\ref{fig:det_regul_sin}). Но при этом \`уже диапазон, в
котором изменяется количество ценных бумаг каждого
типа.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/det_regul_term_sin}
  \caption{Детерминированная модель с регуляризацией}
  \label{fig:det_regul_term_sin}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Недетерминированная модель}\label{sec:nondet}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В настоящем разделе рассмотрим случай, когда точно не известны будущие стоимости активов, и модель должна оперировать прогнозируемыми
значениями на горизонте планирования.

Покажем, что для недетерминированного случая
нельзя просто использовать предсказания и работать
как в детерминированном случае без регуляризации.

На рисунке \ref{fig:nodet_no_reg_no_term} представлен
такой случай, при этом на нижнем графике видно, что
стоимость портфеля при тривиальном управлении будет
выше, нежели при управлении MPC.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/no_det_no_term_not_regul}
  \caption{Недетерменированная модель без регуляризацией}
  \label{fig:nodet_no_reg_no_term}
\end{figure}

Это связано с тем, что управление строится на основе
прогнозируемых данных, и при этом одинаково учитывается
весь горизонт планирования. А хотелось бы сделать
так, чтоб более дальним прогнозам уделялось
меньше внимания.

Из это делаем вывод, что необходимо вводить функцию
стоимости этапа, которая будет учитывать ошибки
прогнозирования.

В случае, когда точно не известны значения $s_i(t)$ и $b_i(t)$,
наша функция перехода для $x_0(t)$, в соответствии
с (\ref{def:xt}) имеет следующий вид:

\begin{equation}
x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t).
\end{equation}

Где $B(t)$ и $S(t)$ описаны в (\ref{eq:vec}).

И при этом $B(t) = (I + E_1(t))\bar B(t)$, где $\bar B(t)$ это прогнозируемое значение, $I$ -- единичная
матрица, $E_1(t)$ -- случайная диагональная матрица ошибок, при этом $M[E_1(t)] = 0$ (ссылка на часть
с оценкой ошибок прогнозирования). Аналогично для $S(t) = \bar S(t)(1 + E_2(t))$.

Так как изменение цены покупки и продажи происходит одинаково, то будем считать,
что $E_1(t)\equiv E_2(t) = E(t)$

Сейчас перепишем (\ref{def:xt}):

\begin{equation}
\begin{split}
x_0(t+1) &= x_0(t) - \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t) - \\
&- \left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t).
\end{split}
\end{equation}

Оценим для величины $x_0(t+1)$ математическое ожидание и дисперсию:

\begin{equation}\label{ned_exp}
M[x_0(t+1)] = M[x_0(t)] + \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t)
\end{equation}

Будем считать, что величины $x_0(t)$ и $W(t)$ независимы, кроме того, стоимости активов не коррелируют
\begin{equation}
\begin{split}
D[x_0(t+1)] &= D[x_0(t) - \left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t)]= \\
 &=D[x_0(t)] + D[\left(E(t) \bar B(t)\right)^T U^+(t) + \left(E(t) \bar S(t) \right)^T U^-(t)]\le \\
 &=D[x_0(t)] + \langle\bar B(t)^T D[E(t)], U^+(t)\rangle^2 + \langle\bar S(t)^T D[E(t)], U^-(t)\rangle^2.
\end{split}
\end{equation}

Сейчас можем добавить учет дисперсии в функцию перехода, эта добавка будит служить
своего рода ограничением дисперсии при максимизации математического ожидания. Введем функцию стоимости
этапа следующим образом:

\begin{equation}
L(U^+(t),U^-(t)) = \alpha\left( \langle\bar B(t)^T D[E(t)], U^+(t)\rangle^2 + \langle\bar S(t)^T D[E(t)], U^-(t)\rangle^2\right).
\end{equation}


Оценки на значения $D[E(t)]$ зависят от способа предсказания векторов $S(t)$ и $B(t)$.

\begin{equation}\label{term_reg}
\begin{split}
&\max_{U^+, U^-} -\sum_{t=0}^{T-1} L_t(U^+(t_0+t),U^-(t_0+t)) + \\
&\ \ \ \ \ \ \ \ \ \ + x_0(t_0+T) + S(t_0+T)^T X(t_0+T);  \\
&X(t+1) = X(t) + U^+(t) - U^-(t) \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t)  \\
&X(t_0) = X_0; \\
&x_(t_0) = x_0; \\
&X(t)\ge 0, \ \ t= \overline{t_0,t_0+T}; \\
&x_0(t)\ge 0; \\
&U^+(t)\ge 0, \ \ t= overline{t_0,t_0+T-1}; \\
&U^-(t)\ge 0;\\
&\frac{x_k(t_0+T)}{\sum_{i=0}^N x_i(t_0+T)} = \frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \ \forall k\in \overline{0,N}.
\end{split}
\end{equation}

Результат применения данного управления представлен
на рисунке \ref{fig:nodet_reg_term}. Тут видим, что
применение управления MPC уже лучше, нежели
тривиальное управление.

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{figs/nodet_term_reg}
  \caption{Недетерменированная модель с регуляризацией}
  \label{fig:nodet_reg_term}
\end{figure}

