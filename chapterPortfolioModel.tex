\chapter{Модель}

В данной главе введем основные понятия и обозначения,
которые будем использовать в дальнейшем для 
решения задачи оптимизации портфеля.


Портфель -- совокупность инвестиционных вложений, состоящих из ценных бумаг и 
свободных финансов.

Портфель состоит из $N$ типов бумаг. Количество бумаг $i$-го типа в момент времени
$t\in \overline{0,T}$ равняется $x_i(t)$, где $x_i(t)\in R_{\ge 0}$. Введем вектор 
$$X(t) = \{x_1(t),x_2(t),\dots,x_N(t)\}^T$$
Обозначим $x_0(t)$ как
количество свободных финансов в момент времени $t$.

Под $u^+_i(t)$ мы будем понимать сколько мы купили
ценных бумаг типа $i$ в момент времени
$t$. Под $u^-_i(t)$ мы будем понимать сколько мы продали
ценных бумаг типа $i$ в момент времени
$t$. При этом стоимость
покупки этой бумаги равна $b_i(t)$ (buy), а продажа $s_i(t)$ (sell).

Таким образом, на каждом шаге покупаем ценнных
бумаг типа $i$ на сумму 
$u^+_i(t)b_i(t)$ и продаем на сумму $u^-_i(t)s_i(t)$.

Таким образом, количество свободных средств в следующий момент времени будет
равно 

$$x_0(t+1) = x_0(t) - \sum_{i=1}^N 
\left( -u^+_i(t)b_i(t) + u^-_i(t)s_i(t)\right)$$.

Количество ценных бумаг типа $i$ в момент времени $t+1$
будет равно

$$x_i(t+1) = x_i(t) + u^+(i) - u^-(i)$$

Представим все это в векторной форме. Введем следующие определения:

$$U^+(t)=\{u^+_1(t),\dots,u^+_N(t)\}^T$$
$$U^-(t)=\{u^-_1(t),\dots,u^-_1(t)\}^T$$

$$B(t)=\{b_1(t),\dots,b_N(t)\}^T$$
$$S(t)=\{s_1(t),\dots,s_N(t)\}^T$$


Тогда имеем функцию перехода для $X(t)$:

$$X(t+1) = X(t) + U^+(t) - U^-(t)$$

И для $x_0(t)$:

$$x_0(t+1) = x_0(t) + U^+(t)^t B(t) - U^-(t)^t S(t)$$

На значения $X, U^+, U^-, x_0$ накладываются следующие 
естественные ограничения:

\begin{equation*}
 \begin{split}
    &X(t)\ge 0, \ \ \forall t\in \overline{0,T} \\
    &U^+(t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
    &U^-(t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
    &x_0(t)\ge 0, \ \ \forall t\in \overline{0,T} \\
 \end{split}
\end{equation*}

Введем понятие общей стоимости портфеля.

Пусть $w_i(t)$ общая стоимость бумаг типа $i$, и она равна сумме, которую мы
сейчас можем выручить из ее продажи, т.е. $w_i(t) = x_i(t)  s_i(t)$. $w_0(t)$
будем считать равным $x_0(t)$. Тогда общая стоимость портфеля равна
$$w(t) = \sum_{i=0}^N w_i(t)$$. Или в векторном виде:

$$w(t) = x_0(t) + X(t)^T S(t)$$

\subsection{Данные для численных экспериментов}

В данной главе описаны данные, которые используются для проведения численных экспериментов. Тут же дано описание того,
как строятся прогнозы в случае, когда работаем с недетерменированной моделью.

Тут же будет рассказано, как будут проводиться эксперименты, с какими параметрами и что обозначают графики.

\subsection{Детерменированная модель}

В данной главе мы рассмотрим детерминированную модель,
а именно, когда нам точно известны наперед все значения $s_i(t)$
и $b_i(t)$.

Иными словами $\hat s(t) = s(t)$ и $\hat b(t) = b(t)$

В таком случае, мы можем рассмотреть следующие модели:

\begin{itemize}
\item максимизация стоимости портфеля без терминального множества
\item максимизация стоимости портфеля с терминальным множеством
\end{itemize}

Максимизация стоимости портфеля без терминального множества

Рассмотрим следующую задачу MPC на горизонте планирования $T$

\begin{equation}
\begin{split}
&\max_{U^+, U^-} J(x,u) = w(T) = x_0(T) + X(T)^T S(T) \\
&X(t+1) = X(t) + U^+(t) - U^-(t) \\
&x_0(t+1) = x_0(t) + U^+(t)^t B(t) - U^-(t)^t S(t) \\
&X(t)\ge 0, \ \ \forall t\in \overline{0,T} \\
&U^+(t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
&U^-(t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
&x_0(t)\ge 0, \ \ \forall t\in \overline{0,T} \\
\end{split}
\end{equation}

Отметим, что в данной задаче функция стоимости не ограничена,
кроме того, тут отсутствуют стоимости переходов а есть только
терминальная стоимость.

Так как предположение $J^{*}_{\infty}(x_0) < \infty$ из главы (\ref{chap3}) не выполняется, то мы не можем гарантировать 
устойчивость и исследовать на субоптимальность.

Проведем численные эксперименты для $T=6$ и $N=2$ для
синтетических и настоящих данных.

TODO вставить картинки

Как видим, у нас происходят частые операции вида: продать
все бумаги типа $i$ и на освободившиеся деньги купить
бумаги типа $j$. Это может представлять собой проблему,
так как мы производим сразу большие переводы, что может
привносить с собой большие риски (подробнее об этом будет
рассказано в главе с недетерменированной моделью)

Изменим функцию стоимости таким образом, чтоб добавить в нее
стоимость перехода.

$\min_{U^+, U^-} J(x,u) = \sum_{i=0}^T L(U^+(i), U^-(i)) - w(T)$

Если в качестве функции стоимости взять, скажем

$$L(U^+(t), U^-(t)) = \alpha(U^+(t)^t B(t) + U^-(t)^t S(t))$$

то есть весь оборот денег, который был в момент $t$, то наши
графики изменятся уже следующим образом (для $\alpha=0.1$)


Максимизация стоимости портфеля с терминальным множеством

Рассмотрим следующую задачу MPC на горизонте планирования $T$

\begin{equation}\label{term_reg}
\begin{split}
&\max_{U^+, U^-} J(x(t_0),u) = x_0(t_0+T) + X(t_0+T)^T S(t_0+T) \\
&X(t+1) = X(t) + U^+(t) - U^-(t) \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t)  \\
&X(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T} \\
&U^+(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
&U^-(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
&x_0(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T} \\
&frac{x_k(t_0+T)}{\sum_{i=0}^N x_i(t_0+T)} = frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \ \forall k\in \overline{0,N} 
\end{split}
\end{equation}

иными словами, требуется, чтоб в момент времени $t_0+T$ пропорции
в портфеле вернулись к тем, что были в нулевой момент времени.
Идея данного подхода совпадает с той, что используется в
экономическом MPC (только там в качестве устойчивого состояния
используется точка $x_s$, а в нашем случае это целый луч).

\begin{theorem}
Задача (\ref{term_reg}) достижима.
\begin{proof}
Заметим, что управление 

$$U^+(t_0+е)=U^-(t_0+t)\equiv 0,\ \ \forall t\in \overline{0,T-1}$$

является допустимым, следовательно наша задача достижима.
\end{proof}
\end{theorem} 

Введем понятие нулевого управления, под ним мы будем понимать
управление, постоянно равное нулю и обозначим его $NULL$

$$U^+(t)=U^-(t)\equiv 0$$

\begin{theorem}
Пусть для $x_0(0),X(0)$ из задачи (\ref{term_req})
получено управление MPC 
$$\{(U(0), X(1)), (U(1), X(2)), \dots\}$$ 
тогда любого $M > 0$ верно:
$$\max_{U^+, U^-} J(x(M),u) \ge x_0(0) + X(0)^T S(M+T)$$
\begin{proof}
Будет добавлено позже
\end{proof}
\end{theorem} 

Иными словами, это означает, что в любой момент времени, 
портфель, управляемый MPC за $T$ шагов может быть приведен
в терминальное множество и при этом стоимость портфеля будет
больше, нежели мы бы постоянно использовали нулевое управление.

\subsection{Недетерминированная модель}

В данной главе рассмотрен случай, когда точно не известны будущие стоимости 
активов и мы должны 

В случае, когда точно не известны значения $s_i(t)$ и $b_i(t)$, 
наша функция перехода для $x_0(t)$ имеет следующий вид:

\begin{equation}\label{ned_x0}
x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t)
\end{equation}
$$$$

Где 

$$B(t)=\{b_1(t),\dots,b_N(t)\}^T$$
$$S(t)=\{s_1(t),\dots,s_N(t)\}^T$$

И при этом $B(t) = \bar B(t)(1 + W_1(t))$, где $\bar B(t)$ это предсказанное
состояние а $M[W_1(t)] = 0$. Аналогично для $S(t) = \bar S(t)(1 + W_2(t))$.

Так как повышение цены покупки и продажи происходит одинаково, то будем считать, 
что $W_1(t)\equiv W_2(t) = W(t)$

Сейчас перепишем (\ref{ned_x0}):

\begin{equation}
\begin{split}
x_0(t+1) &= x_0(t) + \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t) \\
&- \left(\bar B(t) W(t)\right)^T U^+(t) + \left(\bar S(t) W(t)\right)^T U^-(t)
\end{split}
\end{equation}

Оценим для величины $x_0(t+1)$ математическое ожидание и дисперсию:

\begin{equation}\label{ned_exp}
M[x_0(t+1)] = M[x_0(t)] + \bar B(t)^T U^+(t) + \bar S(t)^T U^-(t) 
\end{equation}

Будем считать, что величины $x_0(t)$ и $W(t)$ независимы
\begin{equation}
\begin{split}
D[x_0(t+1)] &= D[x_0(t) - \left(\bar B(t) W(t)\right)^T U^+(t) + \left(\bar S(t) W(t)\right)^T U^-(t)]= \\
 &=D[x_0(t)] + D[W(t)^T\left(\bar B(t)^T U^+(t) + \bar S(t)^T U^-(t)\right)]= \\
 &=D[x_0(t)] + D[W(t)^T] \left(\bar B(t)^T U^+(t) + \bar S(t)^T U^-(t)\right)^2
\end{split}
\end{equation}

Сейчас можем добавить учет дисперсии в функцию перехода

$$L_t(U^+(t),U^-(t),\bar B(t), \bar S(t), D[W(t)^T]) = \alpha * D[W(t)^T] \left(\bar B(t)^T U^+(t) + \bar S(t)^T U^-(t)\right)^2$$

Оценки на значения $D[W(t)^T]$ зависят от способа предсказания векторов $S(t)$ и $B(t)$.

\begin{equation}\label{term_reg}
\begin{split}
&\max_{U^+, U^-} -\sum_{t=0}^{T-1} L_t(U^+(t),U^-(t),\bar B(t), \bar S(t), D[W(t)^T]) + x_0(t_0+T) + X(t_0+T)^T S(t_0+T) \\
&X(t+1) = X(t) + U^+(t) - U^-(t) \\
&x_0(t+1) = x_0(t) - B(t)^T U^+(t) + S(t)^T U^-(t)  \\
&X(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T} \\
&U^+(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
&U^-(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T-1} \\
&x_0(t_0+t)\ge 0, \ \ \forall t\in \overline{0,T} \\
&frac{x_k(t_0+T)}{\sum_{i=0}^N x_i(t_0+T)} = frac{x_k(0)}{\sum_{i=0}^N x_i(0)}, \ \ \forall k\in \overline{0,N} 
\end{split}
\end{equation}