\chapter{Модель}

Портфель -- совокупность инвестиционных вложений, состоящих из ценных бумаг и 
свободных финансов.

Портфель состоит из $N$ типов бумаг. Количество бумаг $i$-го типа в момент времени
$t\in \overline{0,T}$ равняется $x_i(t)$, где $x_i(t)\in R_{\ge 0}$. Под $x_0(t)$ мы будем принимать
количество свободных финансов в момент времени $t$.

Под $u_i(t)$ будем понимать изменение количества $i$-й бумаги в момент
$t$. Аналогом этого в реальном мире служит покупка или продажа. При этом стоимость
покупки этой бумаги равна $B_i(t)$ (buy), а продажа $S_i(t)$ (sell).

Таким образом, если $u_i(t) > 0$, то мы купили бумаг за 
$C_i(t)=u_i(t)  B_i(t)$ свободных средств. Иначе мы бумаги продали
за $-C_i(t)$, где $C_i(t) = u_i(t)  S_i(t)$.

Таким образом, количество свободных средств в следующий момент времени будет
равно 

$$n_0(t+1) = n_0(t) - \sum_{i=1}^N C_i(t)$$.


Введем понятие общей стоимости портфеля.

Пусть $W_i(t)$ общая стоимость бумаг типа $i$, и она равна сумме, которую
сейчас можем выручить из ее продажи, т.е. $W_i(t) = n_i(t)  S_i(t)$. $W_0(t)$
будем считать равным $n_0(t)$. Тогда общая стоимость портфеля равна
$$W(t) = \sum_{i=0}^N W_i(t)$$. 

Аналогично введем $W_{base}(t)$ как стоимость стоимость портфеля в момент $t$,
если бы над ним не производилось никаких операций и его состав был бы первоначчальным
и равнялся $n_0$. 

Цель данной работы заключается в предоставлении системы хранения сбережений,
при которой изначально задается некий портфель, который на протяжении времени на
основании прогнозов корректируется, но его итоговые пропорции не сильно откланяются
от первоначальных. Более формально: в нулевой момент времени состав портфеля представляется
вектором $x(0)$, задача состоит в том, чтоб в момент времени $T$ получить 
портфель $x(T)$ такой что:

$$|\frac{x_i(T)}{\sum_{j=0}^{N}x_j(T)} - \frac{x_i(0)}{\sum_{j=0}^{N}x_j(0)}| \le \mu$$

для
всех $i$, где $\mu$ это допустимое отклонение. Заметим, что значения $u_i(t)$
являются управляющеми, и из всех допустимых управлений нас интересует то, которое
максимизирует $W(T)$.

Таким образом, задачу можно сформулировать следующим образом, для заданных
$n_i(0), S_i(t), B_i(t), \mu$ найти управление $u_i(t)$, т.ч.


\begin{equation}
\left \{ 
\begin{tabular}{c} 
$\max_u W(t)$ \\
$n_i(t) \ge 0$, $\forall i\in \overline{0,N}$, $\forall t \in \overline{0,T}$ \\
$|\frac{x_i(T)}{\sum_{j=0}^{N}x_j(T)} - \frac{x_i(0)}{\sum_{j=0}^{N}x_j(0)}| \le \mu$
\end{tabular} 
\right .
\end{equation}


В реальной жизни точно указать значения $S_i(t)$ и $B_i(t)$ невозможно. Поэтому 
в работе будут у этих функций выделяться детерминированная и недетерминированная 
составляющии, $S_i(t) = \bar S_i(t) + \lambda_S(t)$, 
$B_i(t) = \bar B_i(t) + \lambda_B(t)$, где в качестве $\lambda$ выступает некий
случайный процесс.


\section{Детермениррованая модель}

Предположим, что возможно заранее точно предстказать значения $S_i(t)$ и $B_i(t)$.
Представим задачу в следующей форме:

\begin{equation}
\begin{tabular}{c}
$x(t+1)=A(t)x(t)+B(t)u(t)$ \\ 
$\min_u V_T(x,u) = \sum_{i=0}^{T-1}l(x(i),u(i)) + V_f(x(T)) - (W(T)/W_{base}(T))$ \\
$|\frac{x_i(T)}{\sum_{j=0}^{N}x_j(T)} - \frac{x_i(0)}{\sum_{j=0}^{N}x_j(0)}| \le \mu$
\end{tabular}
\end{equation}

Матрицы $A(t)$ и $B(t)$ линейно зависят от $S(t)$ и $B(t)$.

Об $l(x(i),u(i))$ будет говориться позднее и в дескретном случае оно используется для
устойчивости. А в случае неопределенности TODO

Заметим, что в данном случае, однажды попав в терминальный регион можно всегда
остаться в нем использовав нулевое управление.

Замечание: можно показать, что $V_T(x,u)\ge V_T(x^+, u^+)$. Для доказательства этого
будем, как и в Майне, воспользуемся управлением ${u(1),\dots,u(T-1),0}$. Эта траектория
удавлетворяет терминальным тредованиям. Кроме того, если пропорции нашего портфеля
достаточно близки к изначальным пропорциям, то $W(T)/W_{base}(T)$ почти равен
$W(T+1)/W_{base}(T+1)$. Это нужно будет аккуратно показать, возможно усреднить, как
в случае с EMPC.

\section{Недетерминированая модель}

Будующая цена на акции моделируется при помощи линейной регресси на основании некоторого
прошедшего промежутка. Моделируются значении на каждый из $T$ последующих шагов.

Ниже представлю распределение ошибок для предсказания значения в следующий момент времени

TODO

Видно, что с определенной точностью (гипотезу проверю), мы можем считать, что величина отклоняется
согласно нормальному распределению. Работа с такого рода ошибками описана в статье
"Cautious Model Predictive Control using Gaussian Process Regression  Lukas Hewing, Melanie N. Zeilinger.
От туда вазьму функцию стоимости $l(\mu_i,\Sigma_i,u_i)$, то есть стоимость управления зависит от того,
на сколько точно мы можем предсказать значения $S$ и $B$ в этот момент.
